<!DOCTYPE html>
<html>
    <head>
        <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Andrew Bunday [Tags]</title>

    <link rel="shortcut icon" href="/assets/img/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/cosmo.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for andrewbunday.co.uk" href="/rss.xml" />

    <script type="text/javascript" src="/assets/js/jquery.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-772003-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

    </head>
    <body>
        <div class="page">
            <div class="navbar navbar-static-top">
    <div class="navbar-inner main-navbar-inner">
        <div class="container-fluid main-navbar">
            <a class="btn btn-navbar pull-right" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
           </a>

            <div class="nav-collapse pull-right">
                <ul class="nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="https://github.com/andrewbunday" target="_blank">Github</a></li>
                    <li><a href="http://www.linkedin.com/in/andrewbunday" target="_blank">LinkedIn</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

            <!-- <div class="row"> -->
    <div class="page-header row-fluid">
        <h1>Andrew Bunday <small>tech notes</small></h1>
    </div>


            <div class="row-fluid" id="breadcrumb">
    <ul class="nav nav-pills">
      <li><a href="/">home</a></li>
      
      
      
        <li class="active">
            <a href="#">tags</a>
        </li>
      
    </ul>
</div>


            <div class="container-fluid main-content">
                <div class="row-fluid">
                    <div class="span12 span12-tablet">
                        <div class="row-fluid" style="margin-top:-20px;">
                            
<div class="row-fluid">
    Bash<p>On friday I was reminded of a script I used last February 13th to celebrate the
unix timestamp reaching ‘1234567890’ seconds since the epoch.</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span>date <span class="s1">&#39;+%s&#39;</span><span class="sb">`</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$time</span> -lt 1234567890 <span class="o">]</span>; <span class="k">do</span>
<span class="c">#echo &#39;waiting...&#39;</span>
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span>date <span class="s1">&#39;+%s&#39;</span><span class="sb">`</span>
<span class="k">done</span>

afplay <span class="s1">&#39;/Users/andrewbunday/Music/iTunes/iTunes Music/DMX/Cradle 2 the Grave/01 X Gonna Give It to Ya.mp3&#39;</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    Unix Time<p>On friday I was reminded of a script I used last February 13th to celebrate the
unix timestamp reaching ‘1234567890’ seconds since the epoch.</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span>date <span class="s1">&#39;+%s&#39;</span><span class="sb">`</span>
<span class="k">while</span> <span class="o">[</span> <span class="nv">$time</span> -lt 1234567890 <span class="o">]</span>; <span class="k">do</span>
<span class="c">#echo &#39;waiting...&#39;</span>
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span>date <span class="s1">&#39;+%s&#39;</span><span class="sb">`</span>
<span class="k">done</span>

afplay <span class="s1">&#39;/Users/andrewbunday/Music/iTunes/iTunes Music/DMX/Cradle 2 the Grave/01 X Gonna Give It to Ya.mp3&#39;</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    oped<p>I’ve been a user for around 8 years now. It started out during the summer before
my 2nd year of Uni. My Dad gave me a 2nd gen iPod, with a stonking 10GB of
space.</p>

<p>At the time I didn’t have 10GB of music stored as mp3s and our PC at home didn’t
even have a HDD that large. Windows didn’t have iTunes so Apple supplied a
plugin for a peice of craptacular software to handle syncing and that had to be
done over a firewire connection.</p>

<p>Since those easly days I’ve worked my way through 3 i-devices, my iPod(2nd gen),
a iPod nano and an iPhone 3Gs. I even strayed away for a short time with another
mp3 player whilst travelling for a few months.</p>

<p>The plugin was replaced with iTunes on Windows and firewire was replaced with
good ol’ USB 2.0. Battery life improved and each player got smaller, lighter and
more powerful, capable of handling a multitude of tasks.</p>

<p>But through all this time one accessory has failed to be improved. Those damn
stupid stock earbuds.</p>

<p><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/IPod_Earbuds.JPG/800px-IPod_Earbuds.JPG" alt="Apple Earbuds" /></p>

<p>Lets take a quick look at this image, on the left are a pair of early buds, on
the right some of the current ones you’ll get if you buy a new iPod. Their
aesthetic has been changed, removing the harsh duplo styling of the originals
and replacing it with a smoother softer look in keeping with the design of other
Apple products. They’ve also picked up a slightly rubberier edge to the bud so
that it no longer scratches quite as much as they previously did.</p>

<p>And yet that’s about all they’ve done.</p>

<p>Over the 9 years since the original iPod was introduced we’ve now got touch
screens on all but the very smallest of the players. Battery lives through the
roof, <em>somewhat</em> improved sound quality and string of other improvements.
Apple’s design is sometimes called evolutionary rather than revolutionary. Yet
in the case of their headphones its practically stagnant.</p>

<p>So we all carry on doing what we’ve had to do for all these long years and carry
on buying our own extra headphones on the side.</p>

<p><em>I wrote this whilst wearing a pair of HD380 pro’s. Slightly ott, but you get
the point.</em></p>


    {}
</div>
<hr/>

<div class="row-fluid">
    kindle<p>A couple of weeks ago whilst browsing around the Kindle store documentation
looking up using the platform as a publishing service I came across the Kindle
Developer pages and remembered having seen them been launched a few months
earlier.</p>

<p>When I’d originally taken a glance at the pages I didn’t have any ideas of what
I could create for the Kindle, especially in light of having not had one at the
time. Since then I bought one of the newest ones, receiving mine on release day
was a fantastic feeling (especially when my iPad co-joined flatmate started
eyeing it up).</p>

<p>In the few months since I’ve gotten more and more used to simply having it on me
all the time. It’s light enough and just small enough to carry pretty much
everywhere, either in my backpack or one of the large roomy pockets I have on my
coat.</p>

<p>Now this isn’t a Kindle review, nor is it a love-fest posting about the device.
I simply want to give some context. You see I now used this thing pretty much
every day which has meant that my mind can occasionally think up little ideas
for things I would like to be able to do with it.</p>

<blockquote>
  <p>As a handy tip, I’ve found that it’ll fit quite happily inside a medium zip-
lock bag making it quite waterproof for reading whilst on a windswept boat, by
the beach or even in the bath</p>
</blockquote>

<p>My idea for an App I’d like to make came from one of these times when I had my
Kindle in its waterproof bag whilst scuba diving up in Scotland. My hands were
damp, along with pretty much everything on the boat so taking a book was a no-
go. But I was able to read away without any problems.</p>

<p>Something however that I wasn’t able to do so easily was record my dives in my
log book.</p>

<p>Previously I’ve switched from having a hand written book to recording all of my
dives in a digital dive log application on my lap top and mobile phone. Of
course taking either of those devices out on the open water is a stupid thing to
do, so I wasn’t able to record my dives until late each day when we got back to
port.</p>

<p>But what if my Kindle had an App which could record that data for me? I know
that it’s probably going to be safe in its pouch, and if it had some data sync
capability I wouldn’t need to worry overtly if it were to be water damaged as
the data would be safe and the device itself is fairly cheap.</p>

<p>So please, if anyone from Amazon with the power to approve my application to
join the KDK were to read this post, please help me out and add me to the
program.</p>

<p>Oh and here is a video of some of us jumping in the water on that dive trip
<a href="http://www.youtube.com/watch?v=gDv_kVD2O2c"><em>via Youtube</em></a></p>

    {}
</div>
<hr/>

<div class="row-fluid">
    gnome<p>If you are like me then you get bored fairly easily. Something which in today’s
constant dip information world is all to easy. An example for me is finding that
I like to have an attractive background on my PC but get bored looking at the
same one for any period of time.</p>

<p>On most recently released systems it’s fairly easy to go to the default desktop
background manager and select a series of images to cycle through along with a
dwell period for each to be displayed.</p>

<p>Apparently that isn’t the case for Gnome.</p>

<p>If you go to the background manager you can select single images, and, crucially
select a pre-defined list of images to cycle through. But there is not facility
to do this yourself. More accurately there isn’t any GUI to help.</p>

<p>It turns out an xml file is needed to be stored under:</p>

<pre><code>/usr/share/gnome-background-properties/
</code></pre>

<p>In this file you name another xml file which defines the images to display and
the display interval for each.</p>

<p>Here are the two files I use:</p>

<p><a href="http://sinotr.eu/darkwallpapers/darkwallpapers.xml">darkwallpapers.xml</a>
<a href="http://sinotr.eu/darkwallpapers/background-1.xml">background-1.xml</a></p>

<p>So, for example we end up with:</p>

<pre><code>/usr/share/gnome-background-properties/darkwallpapers.xml
/home/andrewb/Pictures/darkwallpapers/background-1.xml
</code></pre>

<p>Here is a link to a zip including the files and pictures which I use:
<a href="http://sinotr.eu/darkwallpapers/darkwallpapers.tar.gz">darkwallpapers.tar.gz</a></p>

    {}
</div>
<hr/>

<div class="row-fluid">
    debian<p>Tonight I finally got around to completing the upgrade of the server for this
site from Lenny to Squeeze. As upgrades go it was relatively painless. Well
painless in the same way that you can describe that having your arm ripped off
is painless when its then used as club to bludgeon you to death.</p>

<p>There was a time, as little as 10years ago (now that does scare the bejebus out
of me) when both my knowledge of operating a linux system was, well best
described as on a par with the knowledge that hedgehogs seem to have that roads
are a bad idea but they can’t quite put their finger on why. Oh and the other
reason any kind of upgrade was difficult was because most of the software I had
to hand was shit.</p>

<p>Redhat 8, oh how I loathed you. Particularly the horrific memory leak you had on
my system. And the craptacular gnome theme which you…. oh fedora still uses
it….</p>

<p>Digression aside, the upgrade from Lenny to Squeeze went for the most part
without any hitches. The system remained up, and ssh access was maintained. The
web server restarted successfully and I was left with only two components which
no longer worked.</p>

<p>The first of those was the ftp daemon I run to make uploading and retrieving
multiple files easy. Strangely during the upgrade the package was lost which
meant a simple re-install and ftp was back online.</p>

<p>Then we have MySQL.</p>

<h2 id="mysql">MySQL</h2>

<p>First up you need to remember that the version of mysql changed from 4.x to 5.x
between Lenny and Squeeze. This means that they fucked up the structure in any
existing tables you might be trying to migrate over.</p>

<p>At first I tried to run the upgrade scripts and do everything in what I
perceived to be the ‘right’ way.</p>

<p>But they didn’t work. Or at least didn’t work how the documentation described
they should.</p>

<p>So I gave up and did what I’d do again in the future, which is to purge the
database and start with a fresh install of mysql. Its then easy days to simply
take your database backup and pop it back into the server.</p>

<h2 id="the-moral">The Moral</h2>

<p>Is there a moral to this story and my very long winded rant? Well yes of course
there is or I wouldn’t have made a header for it. Simply put, don’t be afraid of
upgrades or doing things that you haven’t before. The worst that can happen to
you is that you loose everything and have to start again from scratch.</p>

<p>But also hedge your bets and make backups of everything. I used **WP-DBManager
**to mail me periodic backups of my wordpress db which meant that I had the
security of knowing that if everything did go tits up that I’d probably be OK.</p>

<p>A&gt;</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    mysql<p>Tonight I finally got around to completing the upgrade of the server for this
site from Lenny to Squeeze. As upgrades go it was relatively painless. Well
painless in the same way that you can describe that having your arm ripped off
is painless when its then used as club to bludgeon you to death.</p>

<p>There was a time, as little as 10years ago (now that does scare the bejebus out
of me) when both my knowledge of operating a linux system was, well best
described as on a par with the knowledge that hedgehogs seem to have that roads
are a bad idea but they can’t quite put their finger on why. Oh and the other
reason any kind of upgrade was difficult was because most of the software I had
to hand was shit.</p>

<p>Redhat 8, oh how I loathed you. Particularly the horrific memory leak you had on
my system. And the craptacular gnome theme which you…. oh fedora still uses
it….</p>

<p>Digression aside, the upgrade from Lenny to Squeeze went for the most part
without any hitches. The system remained up, and ssh access was maintained. The
web server restarted successfully and I was left with only two components which
no longer worked.</p>

<p>The first of those was the ftp daemon I run to make uploading and retrieving
multiple files easy. Strangely during the upgrade the package was lost which
meant a simple re-install and ftp was back online.</p>

<p>Then we have MySQL.</p>

<h2 id="mysql">MySQL</h2>

<p>First up you need to remember that the version of mysql changed from 4.x to 5.x
between Lenny and Squeeze. This means that they fucked up the structure in any
existing tables you might be trying to migrate over.</p>

<p>At first I tried to run the upgrade scripts and do everything in what I
perceived to be the ‘right’ way.</p>

<p>But they didn’t work. Or at least didn’t work how the documentation described
they should.</p>

<p>So I gave up and did what I’d do again in the future, which is to purge the
database and start with a fresh install of mysql. Its then easy days to simply
take your database backup and pop it back into the server.</p>

<h2 id="the-moral">The Moral</h2>

<p>Is there a moral to this story and my very long winded rant? Well yes of course
there is or I wouldn’t have made a header for it. Simply put, don’t be afraid of
upgrades or doing things that you haven’t before. The worst that can happen to
you is that you loose everything and have to start again from scratch.</p>

<p>But also hedge your bets and make backups of everything. I used **WP-DBManager
**to mail me periodic backups of my wordpress db which meant that I had the
security of knowing that if everything did go tits up that I’d probably be OK.</p>

<p>A&gt;</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    OpEd<p>A lot of words have already been dedicated to talking about Final Cut Pro X
which was released this week on Apple’s App Store.</p>

<p>The many new features and also lack of many has been the main topic which web
commentaries, online reviews and the general public’s tweets and social media
updates have been comprised off. Indeed only a couple of days ago I created a
post of my own:</p>

<blockquote class="twitter-tweet tw-align-center">
    <p> So why has Apple chosen to release Final Cut Pro X now when its obviously only half baked? </p>
    &mdash; Andrew Bunday (@itwat) <a href="https://twitter.com/itwat/status/83661664628641793" data-datetime="2011-06-22T22:24:29+00:00">June 22, 2011</a>
</blockquote>
<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>This pretty much sums up my personal opinion of the new release, which whilst I
know counts for very little in the grand scheme of things is still valid.</p>

<p>For whilst I’m not an editor and have very little desire to be one, I do have
the very unenviable position in a company where it is my responsibility to try
and improve the efficiency of our data pipeline and internal company work flows.
This does mean that I have to work closely with editorial and become involved
whenever we start working with a client who wants to send us a project file or
plates in a data format. Formats which more often that not are entirely archaic.</p>

<p>The obvious first problem that I often encounter is that of the belief that we
should all still be converting all of our image files into DPX file format
images whenever we pass them between facilities. It’s pretty much impossible to
believe that VFX or post house cannot handle OpenEXR today, and yet still we’re
stuck with this legacy. One of the initial causes for not embracing EXR at
smaller companies used to be Shake’s poor performance and minimal support for
the format. Shake of course has been discontinued for a number of years and it
so its only been in the last couple of years that the newer compositing
applications such as Nuke or Fusion have started to be used in companies enough
for the old ideas to be blown away. It can be mind blowing for a Sup to be
asked, “Why can’t we hand on EXRs over to XXX for this shared shot?”.</p>

<p>Coming back to Final Cut, I’m glad that Apple has decided to discard native
support for a number of ageing formats and technologies.</p>

<p>For example, most high end digital film cameras are now file based. Whilst some
may record onto a data tape, the recordings themselves are stored as files. The
Red One produces REDRAW images files, whilst the Arri Alexia can record to
either ProRes format video clips for immediate editing or into ARRIRAW image
files. For editors who still work in companies that are accepting tape based
video, my suggestion is to:</p>

<blockquote>
  <p>Stay with FCP7 for now. Just because a new version has been released, doesn’t
mean you have to get it straight away.</p>
</blockquote>

<p>Another format which is dropped to the wayside is EDLs and XML based edit
export. Whilst the usefulness of the format is undeniable, pretty much eveyone
knows it and can support it, it is old and <em>could</em> be replaced with something
else.</p>

<p>I quite liked this <a href="http://pogue.blogs.nytimes.com/2011/06/23/professional-video-editors-weigh-in-on-final-cut-pro-x/">review</a>
which turned up in the New York Times. Most of the points made are sensible and
rather than simply complaining the author gives solutions to many of them.</p>

<p>Which I guess help to round off this commentary. My final words then are that I
like the new version of FCP, that the technology which has gone into it beneath
the hood is miles ahead from where the last version but which has required much
of the old functionality has had to be dropped. New plugins will need to be
re/written to support some these functions, for which perhaps Apple should have
released a developer version sooner. and some functionality, such as multiple
camera support and project management need to be addressed until the project
can be deemed as professional.</p>

<p>Perhaps it should be called simply “Final Cut X” for now, with the “Pro”
monkeyier added in a few months. Either way, I hope that it encourages editors,
directors and producers to look at the way they’ve been working and helps them
to move into the modern digital era.</p>
<p>It’s that time of year again when CS majors have finished their course work,
polished off more than a few late nights revising for their finals, and finally
are able to start working on their Summer of Code projects.</p>

<p>For anyone unsure of what SoC is, here is a short description:</p>

<blockquote>
  <p>Google Summer of Code is a global program that offers students stipends to
write code for open source projects. We have worked with the open source
community to identify and fund exciting projects for the upcoming summer.</p>
</blockquote>

<p>I always find it interesting to take a quick peek through the project lists at this
time of year to see which organisations signed themselves up, and what projects
are going to be worked on over the summer break. The full list can be found
<a href="http://www.google-melange.com/gsoc/projects/list/google/gsoc2011"><strong>here</strong></a>
for anyone wanted to look themselves.</p>

<p>This year there are a few oss projects which are having effort expended on them
which may turn out to be useful. My particular favourite is probably to try and
create a <a href="http://www.google-
melange.com/gsoc/org/google/gsoc2011/oiio"><strong>Photoshop PSD plugin</strong></a> for OpenImageIO. If it’s successful
it will provide fantastic functionality to access psd’s to any application which
makes use of the OIIO shared library, without having to make any substantial
changes to your own code. Or using the python binding to OIIO you could hook
together simple processes such as a colour space conversion on a PSD file,
passing the output into a renderer compliant mip-mapped texture file.</p>

<p>Reaching the end of my look through the list I was a little disappointed not to
see any of the larger broadcasters or vfx facilities contributing directly to
the organisation/mentor lists. Whilst I know that many of them do already
provide their own mentor-ship and intern programmes don’t you think that it
would be good if they engaged in this public forum too? Or even, and this I
would love to have happen, for the tech communities to gather together and share
our collective knowledge towards a <em>greater good</em>.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    OS X<p>A lot of words have already been dedicated to talking about Final Cut Pro X
which was released this week on Apple’s App Store.</p>

<p>The many new features and also lack of many has been the main topic which web
commentaries, online reviews and the general public’s tweets and social media
updates have been comprised off. Indeed only a couple of days ago I created a
post of my own:</p>

<blockquote class="twitter-tweet tw-align-center">
    <p> So why has Apple chosen to release Final Cut Pro X now when its obviously only half baked? </p>
    &mdash; Andrew Bunday (@itwat) <a href="https://twitter.com/itwat/status/83661664628641793" data-datetime="2011-06-22T22:24:29+00:00">June 22, 2011</a>
</blockquote>
<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>This pretty much sums up my personal opinion of the new release, which whilst I
know counts for very little in the grand scheme of things is still valid.</p>

<p>For whilst I’m not an editor and have very little desire to be one, I do have
the very unenviable position in a company where it is my responsibility to try
and improve the efficiency of our data pipeline and internal company work flows.
This does mean that I have to work closely with editorial and become involved
whenever we start working with a client who wants to send us a project file or
plates in a data format. Formats which more often that not are entirely archaic.</p>

<p>The obvious first problem that I often encounter is that of the belief that we
should all still be converting all of our image files into DPX file format
images whenever we pass them between facilities. It’s pretty much impossible to
believe that VFX or post house cannot handle OpenEXR today, and yet still we’re
stuck with this legacy. One of the initial causes for not embracing EXR at
smaller companies used to be Shake’s poor performance and minimal support for
the format. Shake of course has been discontinued for a number of years and it
so its only been in the last couple of years that the newer compositing
applications such as Nuke or Fusion have started to be used in companies enough
for the old ideas to be blown away. It can be mind blowing for a Sup to be
asked, “Why can’t we hand on EXRs over to XXX for this shared shot?”.</p>

<p>Coming back to Final Cut, I’m glad that Apple has decided to discard native
support for a number of ageing formats and technologies.</p>

<p>For example, most high end digital film cameras are now file based. Whilst some
may record onto a data tape, the recordings themselves are stored as files. The
Red One produces REDRAW images files, whilst the Arri Alexia can record to
either ProRes format video clips for immediate editing or into ARRIRAW image
files. For editors who still work in companies that are accepting tape based
video, my suggestion is to:</p>

<blockquote>
  <p>Stay with FCP7 for now. Just because a new version has been released, doesn’t
mean you have to get it straight away.</p>
</blockquote>

<p>Another format which is dropped to the wayside is EDLs and XML based edit
export. Whilst the usefulness of the format is undeniable, pretty much eveyone
knows it and can support it, it is old and <em>could</em> be replaced with something
else.</p>

<p>I quite liked this <a href="http://pogue.blogs.nytimes.com/2011/06/23/professional-video-editors-weigh-in-on-final-cut-pro-x/">review</a>
which turned up in the New York Times. Most of the points made are sensible and
rather than simply complaining the author gives solutions to many of them.</p>

<p>Which I guess help to round off this commentary. My final words then are that I
like the new version of FCP, that the technology which has gone into it beneath
the hood is miles ahead from where the last version but which has required much
of the old functionality has had to be dropped. New plugins will need to be
re/written to support some these functions, for which perhaps Apple should have
released a developer version sooner. and some functionality, such as multiple
camera support and project management need to be addressed until the project
can be deemed as professional.</p>

<p>Perhaps it should be called simply “Final Cut X” for now, with the “Pro”
monkeyier added in a few months. Either way, I hope that it encourages editors,
directors and producers to look at the way they’ve been working and helps them
to move into the modern digital era.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    jockey<p>After posting up a short rage post about <a href="http://www.andrewbunday.com/2011/07/raging-on-jockey/">Jockey</a>
I decided to dive into the deb package file which nvidia current is installed
from and I realised that the postinst script actually does most of the heavy
lifting for me when installing the driver.</p>

<p>It first runs <strong>update-alternatives</strong> on a modprobe.conf file to ensure that the
nouveau driver is blacklisted. Next is adds the kernel module into <strong>dkms</strong> and
starts the autoinstaller. Finally it runs <strong>modprobe</strong> to add the kernel module
into the kernel.</p>

<p>Which made me realise that jockey brings absolutely nothing to the table. Its
now been replaced with these two lines of effective shell script:</p>

<div class="highlight"><pre><code class="bash">    <span class="nv">$ </span>apt-get install nvidia-current
    <span class="nv">$ </span>nvidia-xconfig
</code></pre></div>

<p>Awesome.</p>
<p>Recently I’ve been raging out quite frequently against some of the technology
I’ve been having to come acquainted  with. In particular there is Puppet a
centralised configuration tools which we’ve been using to orchestrate our
automated deployment system in conjunction with apt-get and reprepro as our
backend package respository here at Baseblack.</p>

<p>However describing the system we’ve been building is the topic of another for
longer and more interesting post. Where I can cover some of the hurdles we’ve
encountered and how we’ve dealt with them, despite some of the frankly bizarre
behaviours which Puppet exhibits.</p>

<h3 id="bloatware">Bloatware</h3>

<p>No, instead I’m going to pick on <strong>jockey-text</strong>. Jockey-text is the command
script version of the gtk interface provided with Ubuntu for the last few
releases for installing hardware drivers attached to the system. Specifically
graphics card adaptors, printers and firmware updates are handled by jockey. To
cope with such a broad range of packages to install, kernel modules to enable
and devices to probe for Jockey has become something of a behemoth.</p>

<p>The jockey-text executable itself is quite short, mearly wrapping the jockey
python module. However the module’s source runs at close to 4 1/2K lines of
code. This 4500 lines is taken up by numerous; private nested functions, class
methods and dbus-functions which bloat Jockey massively beyond what should be
required of it.</p>

<h3 id="exit-codes">Exit Codes</h3>

<p>However none of this should have mattered to us. Instead jockey should be doing
its thing and leaving us to get on with what we’ve been working on. To get a
workstation net installed and completely configured without human interation.</p>

<p>Unfortunately despite its near 4.5K of code, there is very little good exception
handling or adherence with the rules of program exit codes. You see should it
not get to the end of its run, because for example the driver your asking to be
enabled, has already been. Then jockey will immediately exit with a value of 1.</p>

<p>That makes it pretty darned hard to use with any confidence.</p>

<h3 id="installing-a-graphics-driver">Installing a graphics driver</h3>

<p>In our the action we wanted jockey to do was enable the nvidia driver which
we’re apt-getting from the x-swat ubuntu ppa. Getting annoyed with jockey, and
not particularly wanting to have to fight with Puppet, I decided to have a dive
into the jockey source and see what its really doing.</p>

<p>Here I present an immensely cut down version of what it’s really doing (in our
edge case).</p>

<p>Pretty simple huh? I’m still undecided about how we’re going to go about
installing our nvidia drivers. Although I have the sneaking susupission that
we’ll probably be <em>apt-get installing</em> them ourselves and then calling <em>nvidia-
xconfig</em> to enable them before rebooting at the end of the installation.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    nvidia<p>After posting up a short rage post about <a href="http://www.andrewbunday.com/2011/07/raging-on-jockey/">Jockey</a>
I decided to dive into the deb package file which nvidia current is installed
from and I realised that the postinst script actually does most of the heavy
lifting for me when installing the driver.</p>

<p>It first runs <strong>update-alternatives</strong> on a modprobe.conf file to ensure that the
nouveau driver is blacklisted. Next is adds the kernel module into <strong>dkms</strong> and
starts the autoinstaller. Finally it runs <strong>modprobe</strong> to add the kernel module
into the kernel.</p>

<p>Which made me realise that jockey brings absolutely nothing to the table. Its
now been replaced with these two lines of effective shell script:</p>

<div class="highlight"><pre><code class="bash">    <span class="nv">$ </span>apt-get install nvidia-current
    <span class="nv">$ </span>nvidia-xconfig
</code></pre></div>

<p>Awesome.</p>
<p>Recently I’ve been raging out quite frequently against some of the technology
I’ve been having to come acquainted  with. In particular there is Puppet a
centralised configuration tools which we’ve been using to orchestrate our
automated deployment system in conjunction with apt-get and reprepro as our
backend package respository here at Baseblack.</p>

<p>However describing the system we’ve been building is the topic of another for
longer and more interesting post. Where I can cover some of the hurdles we’ve
encountered and how we’ve dealt with them, despite some of the frankly bizarre
behaviours which Puppet exhibits.</p>

<h3 id="bloatware">Bloatware</h3>

<p>No, instead I’m going to pick on <strong>jockey-text</strong>. Jockey-text is the command
script version of the gtk interface provided with Ubuntu for the last few
releases for installing hardware drivers attached to the system. Specifically
graphics card adaptors, printers and firmware updates are handled by jockey. To
cope with such a broad range of packages to install, kernel modules to enable
and devices to probe for Jockey has become something of a behemoth.</p>

<p>The jockey-text executable itself is quite short, mearly wrapping the jockey
python module. However the module’s source runs at close to 4 1/2K lines of
code. This 4500 lines is taken up by numerous; private nested functions, class
methods and dbus-functions which bloat Jockey massively beyond what should be
required of it.</p>

<h3 id="exit-codes">Exit Codes</h3>

<p>However none of this should have mattered to us. Instead jockey should be doing
its thing and leaving us to get on with what we’ve been working on. To get a
workstation net installed and completely configured without human interation.</p>

<p>Unfortunately despite its near 4.5K of code, there is very little good exception
handling or adherence with the rules of program exit codes. You see should it
not get to the end of its run, because for example the driver your asking to be
enabled, has already been. Then jockey will immediately exit with a value of 1.</p>

<p>That makes it pretty darned hard to use with any confidence.</p>

<h3 id="installing-a-graphics-driver">Installing a graphics driver</h3>

<p>In our the action we wanted jockey to do was enable the nvidia driver which
we’re apt-getting from the x-swat ubuntu ppa. Getting annoyed with jockey, and
not particularly wanting to have to fight with Puppet, I decided to have a dive
into the jockey source and see what its really doing.</p>

<p>Here I present an immensely cut down version of what it’s really doing (in our
edge case).</p>

<p>Pretty simple huh? I’m still undecided about how we’re going to go about
installing our nvidia drivers. Although I have the sneaking susupission that
we’ll probably be <em>apt-get installing</em> them ourselves and then calling <em>nvidia-
xconfig</em> to enable them before rebooting at the end of the installation.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    nikon<p>Yesterday myself, Bob, Phil and Fay heading down the Discover Dogs event held at
Earl’s Court in London. This is an edit of what we saw. It was recorded using a
Nikon D5100 and 50mm prime.</p>

<iframe src="http://player.vimeo.com/video/32043282?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/32043282">The Dog Show</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    GoPro<iframe src="http://player.vimeo.com/video/33862996?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p>
    <a href="http://vimeo.com/33862996">Cake Baking</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.
</p>
<p>The updates are starting to come in thick and fast. Here is a quick blast of
shots from the mini ride around London, to the M25 and back home trying out how
best to use the chest harness for my GoPro.</p>

<iframe src="http://player.vimeo.com/video/33864071?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/33864071">GoPro Motorcycle Montage</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

<p>Earlier in the week I strapped on my new GoPro camera onto my noggin after
running around in the Hyde park for an hour. I’ll try and record one of the BMF
sessions sometime to see just how much I throw myself about during class.</p>

<iframe src="http://player.vimeo.com/video/33072392?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/33072392">Through the Park</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

<p>Yesterday myself, Bob, Phil and Fay heading down the Discover Dogs event held at
Earl’s Court in London. This is an edit of what we saw. It was recorded using a
Nikon D5100 and 50mm prime.</p>

<iframe src="http://player.vimeo.com/video/32043282?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/32043282">The Dog Show</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    dogs<p>Yesterday myself, Bob, Phil and Fay heading down the Discover Dogs event held at
Earl’s Court in London. This is an edit of what we saw. It was recorded using a
Nikon D5100 and 50mm prime.</p>

<iframe src="http://player.vimeo.com/video/32043282?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/32043282">The Dog Show</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    Earls Court<p>Yesterday myself, Bob, Phil and Fay heading down the Discover Dogs event held at
Earl’s Court in London. This is an edit of what we saw. It was recorded using a
Nikon D5100 and 50mm prime.</p>

<iframe src="http://player.vimeo.com/video/32043282?color=F05822" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
<p><a href="http://vimeo.com/32043282">The Dog Show</a> from <a href="http://vimeo.com/andrewbunday">Andrew Bunday</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    mel<p>This kinda thing really gets on my wick. Sometimes a plugin comes along which
doesn’t source it’s own shelves. When that happens you have to hunt around in
the file system to load the shelf. So instead popping this file into the scripts
directory of the plugin</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">maya</span>

<span class="k">def</span> <span class="nf">bbLoadShelf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="n">mainShelfLayout</span> <span class="o">=</span> <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s">&#39;global string $gShelfTopLevel; string $tmp=$gShelfTopLevel;&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">maya</span><span class="o">.</span><span class="n">cmds</span><span class="o">.</span><span class="n">tabLayout</span><span class="p">(</span><span class="n">mainShelfLayout</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">tabLabel</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s">&#39;addNewShelfTab &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="n">maya</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">executeDeferred</span><span class="p">(</span> <span class="n">bbLoadShelf</span><span class="p">(</span><span class="s">&#39;MyPlugin&#39;</span><span class="p">)</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    maya<p>This kinda thing really gets on my wick. Sometimes a plugin comes along which
doesn’t source it’s own shelves. When that happens you have to hunt around in
the file system to load the shelf. So instead popping this file into the scripts
directory of the plugin</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">maya</span>

<span class="k">def</span> <span class="nf">bbLoadShelf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="n">mainShelfLayout</span> <span class="o">=</span> <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s">&#39;global string $gShelfTopLevel; string $tmp=$gShelfTopLevel;&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">maya</span><span class="o">.</span><span class="n">cmds</span><span class="o">.</span><span class="n">tabLayout</span><span class="p">(</span><span class="n">mainShelfLayout</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">tabLabel</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s">&#39;addNewShelfTab &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="n">maya</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">executeDeferred</span><span class="p">(</span> <span class="n">bbLoadShelf</span><span class="p">(</span><span class="s">&#39;MyPlugin&#39;</span><span class="p">)</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    greenlet<p>I had a slightly odd moment a few weeks ago and felt that I really didn’t want to write a PyQt based desktop application.
Instead, fueled by some webapp based docs i’d been reading recently (I blame you @manneohrstrom) which were written using Flask. I decided to try out launching a PyQt QWebView and pointing it back at a local webservice run from the same process.</p>

<p>What I great idea I thought! Jumping in blindly only to quickly discover that both Flask and PyQt want to run in the primary python thread. To get around the problem I fell back onto Greenlets and hand processing events in PyQt rather than giving over control to app._exec().</p>

<p>Ultimately I ended up ditching the whole thing and reverting back to a vanilla
PyQt application since once I started to add user interaction for elements such
as dynamic combo boxes I found that my Javascript skills were sufficiently rusty
that it was taking an age to write the handlers, and callbacks on both ends of
the system.</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWebKit</span>

<span class="kn">import</span> <span class="nn">gevent.wsgi</span>

<span class="k">class</span> <span class="nc">WebView</span><span class="p">(</span><span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="p">(</span><span class="s">&quot;http://localhost:5000/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;closing gui&quot;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;are gui and webserver alive? &quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">dead</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>


<span class="k">class</span> <span class="nc">PyQtGreenlet</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hasPendingEvents</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">fapp</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">fapp</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;http://localhost:5000/bye&quot; &gt; quit() &lt;/a&gt;&lt;/br&gt;&lt;a href=&quot;http://localhost:5000/&quot; &gt; reload &lt;/a&gt;&lt;/br&gt;count={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/bye&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">&quot;killing webserver&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;is webserver alive? &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>
        <span class="n">window</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;goodbye&#39;</span>

    <span class="n">http_server</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">fapp</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span> <span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">WebView</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">PyQtGreenlet</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    PyQt<p>I had a slightly odd moment a few weeks ago and felt that I really didn’t want to write a PyQt based desktop application.
Instead, fueled by some webapp based docs i’d been reading recently (I blame you @manneohrstrom) which were written using Flask. I decided to try out launching a PyQt QWebView and pointing it back at a local webservice run from the same process.</p>

<p>What I great idea I thought! Jumping in blindly only to quickly discover that both Flask and PyQt want to run in the primary python thread. To get around the problem I fell back onto Greenlets and hand processing events in PyQt rather than giving over control to app._exec().</p>

<p>Ultimately I ended up ditching the whole thing and reverting back to a vanilla
PyQt application since once I started to add user interaction for elements such
as dynamic combo boxes I found that my Javascript skills were sufficiently rusty
that it was taking an age to write the handlers, and callbacks on both ends of
the system.</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWebKit</span>

<span class="kn">import</span> <span class="nn">gevent.wsgi</span>

<span class="k">class</span> <span class="nc">WebView</span><span class="p">(</span><span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="p">(</span><span class="s">&quot;http://localhost:5000/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;closing gui&quot;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;are gui and webserver alive? &quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">dead</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>


<span class="k">class</span> <span class="nc">PyQtGreenlet</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hasPendingEvents</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">fapp</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">fapp</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;http://localhost:5000/bye&quot; &gt; quit() &lt;/a&gt;&lt;/br&gt;&lt;a href=&quot;http://localhost:5000/&quot; &gt; reload &lt;/a&gt;&lt;/br&gt;count={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/bye&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">&quot;killing webserver&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;is webserver alive? &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>
        <span class="n">window</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;goodbye&#39;</span>

    <span class="n">http_server</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">fapp</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span> <span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">WebView</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">PyQtGreenlet</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    Flask<p>I had a slightly odd moment a few weeks ago and felt that I really didn’t want to write a PyQt based desktop application.
Instead, fueled by some webapp based docs i’d been reading recently (I blame you @manneohrstrom) which were written using Flask. I decided to try out launching a PyQt QWebView and pointing it back at a local webservice run from the same process.</p>

<p>What I great idea I thought! Jumping in blindly only to quickly discover that both Flask and PyQt want to run in the primary python thread. To get around the problem I fell back onto Greenlets and hand processing events in PyQt rather than giving over control to app._exec().</p>

<p>Ultimately I ended up ditching the whole thing and reverting back to a vanilla
PyQt application since once I started to add user interaction for elements such
as dynamic combo boxes I found that my Javascript skills were sufficiently rusty
that it was taking an age to write the handlers, and callbacks on both ends of
the system.</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWebKit</span>

<span class="kn">import</span> <span class="nn">gevent.wsgi</span>

<span class="k">class</span> <span class="nc">WebView</span><span class="p">(</span><span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="p">(</span><span class="s">&quot;http://localhost:5000/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;closing gui&quot;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;are gui and webserver alive? &quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">dead</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>


<span class="k">class</span> <span class="nc">PyQtGreenlet</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hasPendingEvents</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">fapp</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">fapp</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;http://localhost:5000/bye&quot; &gt; quit() &lt;/a&gt;&lt;/br&gt;&lt;a href=&quot;http://localhost:5000/&quot; &gt; reload &lt;/a&gt;&lt;/br&gt;count={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/bye&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">&quot;killing webserver&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;is webserver alive? &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>
        <span class="n">window</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;goodbye&#39;</span>

    <span class="n">http_server</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">fapp</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span> <span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">WebView</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">PyQtGreenlet</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    python<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#backstory">Backstory</a></li>
  <li><a href="#example">Example</a></li>
  <li><a href="#quick-explanation">Quick Explanation</a></li>
  <li><a href="#the-code">The Code</a></li>
</ul>

<h3 id="backstory">Backstory</h3>

<p>This little example came about following a request from a supervisor who was remembering the ‘old’ days of when they used to use Shake and how they used to have a little histogram overlay which they could apply over the top of their comp during tech checks to quickly see if there where were any illegal values or obvious clipping occurring.</p>

<p>Unfortunately Nuke doesn’t have anything out of the box which quite matches this behaviour, and whilst the histogram Node is lacking, it is not a big enough bug bear to cause anyone to really want to ever launch Shake again.</p>

<p><em>That is a minor lie, the 2D tracker definitely is still good enough when compared to the one in Nuke that we still catch Compositors firing it up for a quick track.</em></p>

<h3 id="example">Example</h3>

<p><img src="https://raw.github.com/andrewbunday/PyHistogram/master/reference/example.png" alt="" /></p>

<h3 id="quick-explanation">Quick Explanation</h3>

<p>So here’s whats happening:</p>

<ol>
  <li>PIL.Image is used to open the input image, in this case a jpg but other formats could be used, and the Image class replaced with a reader for your particular image. The only important feature of the reader class is that it must be capable of formatting the pixel data as an array compatible with pylab.array().</li>
  <li>Each of the channels is extracted from the image for separate manipulation.</li>
  <li>We start a new figure, this initialises pylab.</li>
  <li>For each channel we compute a histogram of the pixel values. These will be displayed, overlaid on the figure, but will not be scaled to fit nicely within the bounds of our reference image.</li>
  <li>We compute the scale to apply to the x/y axis by finding out the maximum number of samples for each channel (X) and the maximum value of each sample (Y).</li>
  <li>All of the image data is displayed, and we modify the labels and properties of the graph axis to improve their legibility. </li>
</ol>

<h3 id="the-code">The Code</h3>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">pylab</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">file_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/../reference/aa_van_and_bike.jpg&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="lineno"> 6</span> <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">255</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="n">im</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="n">blue</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">b</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">11</span> <span class="n">green</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">12</span> <span class="n">red</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">r</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">15</span> <span class="n">b_n</span><span class="p">,</span> <span class="n">b_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">16</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">g_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">17</span> <span class="n">r_n</span><span class="p">,</span> <span class="n">r_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="n">max_samples</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">b_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">g_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_n</span><span class="p">)])</span>
<span class="lineno">20</span> <span class="n">max_density</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">b_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">g_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r_n</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="lineno">21</span> <span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">max_samples</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">max_density</span><span class="p">])</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="lineno">24</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="lineno">25</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">26</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">27</span> <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Saturation (0-1)&#39;</span><span class="p">)</span>
<span class="lineno">28</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Density&#39;</span><span class="p">)</span>
<span class="lineno">29</span> 
<span class="lineno">30</span> <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Color Density Analysis of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno">31</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#current-feature-set">Current Feature Set</a>    <ul>
      <li><a href="#browsing">Browsing</a></li>
      <li><a href="#searching">Searching</a></li>
    </ul>
  </li>
  <li><a href="#future-ideas">Future Ideas</a></li>
  <li><a href="#get-hold-of-it-yourself">Get hold of it yourself</a></li>
  <li><a href="#technical-details">Technical Details</a></li>
</ul>

<h2 id="overview">Overview</h2>

<hr />

<p>A few weeks ago we finished a first draft release of <a href="http://github.com/andrewbunday/reproweb">ReproWeb</a>, a small, light weight apt repository browser. The browser was build out of an increasing need we were finding, to be able to introspect into our main production repository.</p>

<p>Over the course of 1.5 years that repository has grown to the point when the main stable channel contains around 334 individual packages whilst the unstable channel contains a further 149.</p>

<p>Without running apt-cache commands, and munging with our software source lists it was becoming difficult to not only find the name/version of a piece of software, but it was also becoming hard to tell:</p>

<ul>
  <li>When the package was created</li>
  <li>Who created the package</li>
  <li>If the package had a newer version in the unstable channel</li>
  <li>If the package was available in the stable channel</li>
  <li>If the package had been published for all of our supported distributions.</li>
</ul>

<p>Almost all of these tasks can be carried out from a terminal using commands such as <code>apt-get show</code>, but the web interface allows for far quicker navigation, comparison and has already started us asking more questions as our understanding of the data in our repository grows.</p>

<h2 id="current-feature-set">Current Feature Set</h2>

<hr />

<p>At present Reproweb allows a user to perform filters on the content of a repository based on either;</p>

<ul>
  <li>simple string pattern matching against either the package name, version string or codename/component/architecture,</li>
  <li>or by browsing through the hierarchy of the repository from:</li>
</ul>

<blockquote>
  <p>codename -&gt; component -&gt; architecture -&gt; package -&gt; version</p>
</blockquote>

<h3 id="browsing">Browsing</h3>
<hr />

<blockquote>
  <p>Do you find yourself wanting to know more about your repository? Perhaps how many packages are in a particular component? or perhaps you don’t know the structure of your repository and you want to get to know it more intimately?</p>
</blockquote>

<p>These screenshots show:</p>

<ul>
  <li>The root of the repository, listing the currently defined distributions.
Metadata associated with the distribution is also listed along with information such as the components available within the distribtuion and the total number of packages currently published within it.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_07.png" alt="" /></p>

<ul>
  <li>The breadcrumb which is left at the top of the interface as you delve deeper into the repository.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_08.png" alt="" /></p>

<h3 id="searching">Searching</h3>
<hr />

<blockquote>
  <p>Do you have a specific package you are looking for? Do you know it’s name or version and don’t want to have to go browsing around for it?</p>
</blockquote>

<p>The package list shows all of the packages currently available for a given architecture or all of the packages across all of the distributions in the repository. The search box can be used to search through these packages, as you type it will filter out those packages which don’t match.</p>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_05.png" alt="" /></p>

<h2 id="future-ideas">Future Ideas</h2>
<hr />

<p>This is a list of the features which I’d like to add in time.</p>

<ol>
  <li>Make the package view accessable at an point in the browser, so for example
allow listing of packages in a component.</li>
  <li>Complete json endpoints for all urls.</li>
  <li>Renaming or package or version number.</li>
  <li>Listing of unreferrenced versions. Or previous versions which are no longer
available in Releases.gz</li>
  <li>Listing of pre/post install/remove scripts.</li>
</ol>

<h2 id="get-hold-of-it-yourself">Get hold of it yourself</h2>
<hr />

<p>I strongly recommending visiting <a href="http://github.com/andrewbunday/reproweb">http://github.com/andrewbunday/reproweb</a> and start by reading the README and documentation on the repo.</p>

<p>Or for the impatient in life:</p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c"># clone the repository</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> git clone https://github.com/andrewbunday/ReproWeb.git
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="c"># ensure that the cache directory has been created, or that you edit the setting in the configuration before you start up the app.</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> sudo mkdir /var/cache/reproweb
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># start it up</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> python debug-run.py
</code></pre></div>

<h2 id="technical-details">Technical Details</h2>

<hr />

<p>Underneath the hood ReproWeb is built using only a handful of <em>(at the time of writing)</em> actively developed tools.</p>

<p>Development of Reproweb was conciously kept to a tight a deadline. We gave ourselves less than 2 weeks to go from establishing our initial requirements, having looked at the alternatives, to the first releaseable draft.</p>

<p>This drove our decisions behind each of the components we used to build the application.</p>

<ul>
  <li>
    <p><strong>reprepro</strong> - This is the repository management tool which the browser has been designed to be used with. All of the interactions with reprepro are handled through via the 3rd party script reepocheep.py which could be swapped out with an equivalent script which provides the same api.</p>

    <p>Since we were using reprepro already to manage our software package repositories it made complete sense to tailor the app to its strengths.</p>

    <p>The majority of the heavy lifting for the app is handled by calls to reprepro via subprocess and then handling of the returned data.</p>
  </li>
  <li>
    <p><strong>flask</strong> - A small web application backend framework which handles all of the functionality we need for it for this project. Something as feature rich as django would have been more cumbersome that the project required. Other parts of the Flask eco system were utilised, such as jinja2 to handle dynamic page generation.</p>

    <p>This is one of my personally favourite frameworks to use when building these kinds of applications. Having worked previously with django and really having not gotten on well with it I’ve always been attracted to these lighter weight frameworks.</p>

    <p>Another choice a few years ago might have been <a href="http://webpy.org">web.py</a> which truely is a micro framework would have ended up being replaced as it reached its limits a little sooner than flask will.</p>
  </li>
  <li>
    <p><strong>bootstrap</strong> - A very user friendly web front-end framework which handles features such as responsive layout, navbar and general css styling consistency.</p>

    <p>A few years ago if someone had told me that all of the css and jquery plugins I would need to build a webpage/app quickly with little stress I could download and get started with in minutes, I would have laughed and said ‘your sooo funny’. However now Bootstrap does all those things and it has made the lives of non-web developers such as myself far easier.</p>
  </li>
  <li>
    <p><strong>datatables.js</strong> - A damn awesome jquery plugin which completely powers the tabulated, sortable, filterable, paginated list of packages seen in the search view.</p>

    <p>Does what it says on the tin. Credit goes to <a href="http://paulnendick.github.com">@PaulNendick</a> for the find.</p>
  </li>
</ul>
<p>Today I’m happy to have finished up work on a small python wrapper for Proxmox’s rest based API. We’ve called it <a href="http://github.com/baseblack/proxmoxia">Proxmoxia</a>.</p>

<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#creating-proxmoxia">Creating Proxmoxia</a></li>
  <li><a href="#whats-next">Whats Next?</a></li>
  <li><a href="#finally-some-examples">Finally Some Examples</a></li>
</ul>

<h2 id="background">Background</h2>
<hr />

<p>For those who don’t know, <a href="http://pve.proxmox.com/wiki/Main_Page">Proxmox</a> is an open source server virtualization platform which allows you to create and manage any number of virtual machines based on either KVM or OpenVZ.</p>

<p>At Baseblack we utilise Proxmox to provide us with the majority of our central infrastructure. For example we run a pair of DNS servers, an almost countless number of license servers and farm manager all as openvz containers. Doing this provides us with a far higher level of service since if any one of our virtualization nodes go down we can quickly and pretty painlessly re-start the downed services on one of the other nodes whilst we work outs whats happening.</p>

<p>An area of active development for us is the automation of builds of new software packages for deployment onto our workstations, render nodes and virtual hosts.</p>

<blockquote>
  <p><em>This is where Proxmoxia comes in.</em></p>
</blockquote>

<p>Until recently anytime we’ve needed to spin up a new virtual server, we’ve needed to login to the web interface and manually create a new instance. Not only is this tedious and time consuming, but it can also lead to the occasional mistake.</p>

<p>We knew that our plans for automated builds, and testing of packages would involve us spinning up more and more sacrificial virtual machines which we could use as testing/build bots, each being discarded once they had completed their assigned tasks.</p>

<h2 id="creating-proxmoxia">Creating Proxmoxia</h2>
<hr />

<p>After a short burst of <em>‘Spanish Flea’</em> our  preferred google search background music we found that the majority of the existing implementations of wrappers for the rest API had been in languages we either weren’t keen on or flat out refused to use.</p>

<blockquote>
  <p><em>Perl, Java, PHP need not apply</em></p>
</blockquote>

<p>Unfortunately I didn’t come across PyProxmox <em>(a major omission of mine)</em> until I’d already spent the better part of a day planning on how to make proxmoxia. And by then I well and truly had the bit between my teeth.</p>

<p>I wanted to create a library which followed a few simple rules:</p>

<ol>
  <li>It should ‘feel’ pythonic.</li>
  <li>I wanted the wrapper to extend itself. Or in a few more words; I didn’t want to have to personally write wrapper functions for each and every endpoint and method combination which are currently exposed in the rest api.</li>
</ol>

<p>Personally I don’t like PyProxmox’s implementation for both of these reasons which is why I feel justified in completing Proxmoxia.</p>

<h2 id="whats-next">Whats Next?</h2>
<hr />

<p>We’re going to be using the library as part of our testing suite, creating new VMs off of the back of Jenkins builds. Hopefully it’s going to work out to be really useful.</p>

<h2 id="finally-some-examples">Finally Some Examples</h2>
<hr />

<p>Okay, so here are some examples to show what I’m talking about. Head over to the <a href="http://github.com/baseblack/proxmoxia">github</a> site for the source for these.</p>

<p>First up, Proxmox uses a token based authentication mechanism which must be attached to the headers of each request.</p>

<p>Connect to any node in the cluster and get the auth_token:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">proxmox</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Connector</span><span class="p">(</span><span class="s">&#39;proxmox-1&#39;</span><span class="p">,</span> <span class="mi">8006</span><span class="p">)</span>
<span class="n">auth_token</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_auth_token</span><span class="p">(</span><span class="s">&#39;user@pam&#39;</span><span class="p">,</span> <span class="s">&#39;strawberries&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Next create Proxmox and Node access objects, these are the bread and butter of the library:</p>

<div class="highlight"><pre><code class="python"><span class="n">p</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Proxmox</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s">&#39;proxmox-7&#39;</span><span class="p">)</span>  <span class="c"># this is on a different host.</span>
</code></pre></div>

<p>The library translates its requests into the url equivalent of what you call. So here we request the status on a vm with id number 108:</p>

<div class="highlight"><pre><code class="python"><span class="n">vmid</span> <span class="o">=</span> <span class="mi">108</span>
<span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="n">vmid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
</code></pre></div>

<p>Which is converted to the URL:</p>

<pre><code>http://proxmox-1:8006/api2/json/nodes/proxmox-7/openvz/108/status/current
</code></pre>

<p>Find a vm template filepath and use this as the ostemplate for a new vm you create. And then start it up once it has finished being created:</p>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="c"># find the path for the template you want to use.</span>
<span class="lineno"> 2</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">&#39;vztmpl&#39;</span><span class="p">):</span>
<span class="lineno"> 3</span>     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*ubuntu-12.04-bb-20121010b_amd64.tar.gz$&#39;</span><span class="p">,</span> <span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">]):</span>
<span class="lineno"> 4</span>         <span class="n">volume</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="c"># create the container, giving it some sensible settings</span>
<span class="lineno"> 7</span> <span class="n">taskid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="o">.</span><span class="n">post</span><span class="p">(</span> <span class="n">ostemplate</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">),</span>
<span class="lineno"> 8</span>                            <span class="n">vmid</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
<span class="lineno"> 9</span>                            <span class="n">hostname</span><span class="o">=</span><span class="s">&#39;test-4&#39;</span><span class="p">,</span>
<span class="lineno">10</span>                            <span class="n">ip_address</span><span class="o">=</span><span class="s">&#39;192.168.123.204&#39;</span><span class="p">,</span>
<span class="lineno">11</span>                            <span class="n">storage</span><span class="o">=</span><span class="s">&#39;local&#39;</span><span class="p">)</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c"># keep an eye on task and see when its completed</span>
<span class="lineno">14</span> <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">()[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;running&#39;</span><span class="p">:</span>
<span class="lineno">15</span>         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c"># print out the logs</span>
<span class="lineno">18</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">():</span>
<span class="lineno">19</span>     <span class="k">print</span> <span class="n">line</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="k">try</span><span class="p">:</span>
<span class="lineno">22</span>     <span class="c"># start up the container</span>
<span class="lineno">23</span>     <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="s">&#39;204&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>
<span class="lineno">24</span> <span class="k">except</span><span class="p">:</span>
<span class="lineno">25</span>     <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unable to start container&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Find if a user exists and create them if they do not:</p>

<div class="highlight"><pre><code class="python"><span class="k">if</span> <span class="s">&#39;andrew.bunday@pve&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="p">()]:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="s">&#39;andrew.bunday@pve&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;test user&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;strawberries&quot;</span><span class="p">)</span>
</code></pre></div>

<p>I had a slightly odd moment a few weeks ago and felt that I really didn’t want to write a PyQt based desktop application.
Instead, fueled by some webapp based docs i’d been reading recently (I blame you @manneohrstrom) which were written using Flask. I decided to try out launching a PyQt QWebView and pointing it back at a local webservice run from the same process.</p>

<p>What I great idea I thought! Jumping in blindly only to quickly discover that both Flask and PyQt want to run in the primary python thread. To get around the problem I fell back onto Greenlets and hand processing events in PyQt rather than giving over control to app._exec().</p>

<p>Ultimately I ended up ditching the whole thing and reverting back to a vanilla
PyQt application since once I started to add user interaction for elements such
as dynamic combo boxes I found that my Javascript skills were sufficiently rusty
that it was taking an age to write the handlers, and callbacks on both ends of
the system.</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWebKit</span>

<span class="kn">import</span> <span class="nn">gevent.wsgi</span>

<span class="k">class</span> <span class="nc">WebView</span><span class="p">(</span><span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QtWebKit</span><span class="o">.</span><span class="n">QWebView</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="p">(</span><span class="s">&quot;http://localhost:5000/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;closing gui&quot;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">GreenletExit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;are gui and webserver alive? &quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">dead</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>


<span class="k">class</span> <span class="nc">PyQtGreenlet</span><span class="p">(</span><span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">Greenlet</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hasPendingEvents</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">fapp</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">fapp</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;http://localhost:5000/bye&quot; &gt; quit() &lt;/a&gt;&lt;/br&gt;&lt;a href=&quot;http://localhost:5000/&quot; &gt; reload &lt;/a&gt;&lt;/br&gt;count={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="nd">@fapp.route</span><span class="p">(</span><span class="s">&quot;/bye&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">&quot;killing webserver&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;is webserver alive? &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dead</span>
        <span class="n">window</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&quot;clicked()&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;goodbye&#39;</span>

    <span class="n">http_server</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIServer</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">fapp</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span> <span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">WebView</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">PyQtGreenlet</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">([</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    puppet<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#running-masterless">Running Masterless</a></li>
  <li><a href="#an-example-wrapper-script">An Example Wrapper Script</a></li>
</ul>

<h3 id="background">Background</h3>

<hr />

<p>Typically the easiest way to run puppet is to use the default master and agent
mechanism.</p>

<p>When you run puppet using a master the only way to switch between
different sets of manifests/modules is to use environments. If  you setup puppet
correctly these can allow you to pick and choose which environment you want to
use on a given run, and/or for a given node.</p>

<p>Unfortunately there are a few caveats when using environments.</p>

<ul>
  <li>To pick out a particular enviroment for a specific node each time you ideally
should be using an ENC. Once you setup your enviroment == node relationship it’ll
stick for each run.</li>
  <li>
    <p>If you are not using an ENC, since this is another server which you don’t want
to have to maintain then you are requried to specify the environment to use
via the commandline. For example:</p>

    <blockquote>
      <p><code>puppet agent --test --environment canary_maya_001</code></p>
    </blockquote>
  </li>
  <li>Each environment will need to have a different manifest/modulepath defined and
located in your puppet manifests.</li>
</ul>

<h3 id="running-masterless">Running Masterless</h3>

<hr />

<p>Another way of running puppet is to setup it up in in a masterless mode. Here we
instead checkout a copy of our manifest from a central repository and run puppet
directly against it.</p>

<p>Whilst you gain the advantage of not needing a master, and of being able to split
environments more easily with branches (this can be done with the master but requires
multiple checkouts of the puppet repository). You do loose out on a few features
of puppet, such as:</p>

<ul>
  <li>Reports, these really don’t work as well.</li>
  <li>StoreConfigs is probably the biggest feature loss although you should be able
to solve the problems you would have used it for in other ways (SSHFP for example
when handling new server certificates).</li>
  <li>To use a particular environment on a node it becomes easier to create branches
of your manifests/modules and then checkout the branch you want on the node
just before you execute puppet. This still means you have multiple ‘copies’ of
files, but managing them tends to be easier via standard git branch&amp;merge tools.</li>
</ul>

<h3 id="an-example-wrapper-script">An Example Wrapper Script</h3>

<hr />

<p>The steps involved in running masterless are slightly more cumbersome than
running with a master. In particular if you use a git server such as gitolite
then you need to ensure that you have credentials setup which allow you to read
from the repository.</p>

<p>For this we’re using a locally served ssh config file and private rsa id which
the config file informs ssh to use to identifty ourselves when we contact our
gitolite host.</p>

<p><em>served with a pinch of salt</em></p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c">#!/usr/bin/env bash</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c"># check if sudo has been used or user is root</span>
<span class="lineno"> 4</span> <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${SUDO_USER}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${USER}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="lineno"> 5</span> <span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Fail: Only root can execute puppet&quot;</span>
<span class="lineno"> 6</span>     <span class="nb">exit </span>1
<span class="lineno"> 7</span> <span class="k">fi</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># change to &#39;syslog&#39; to redirect puppet&#39;s internal logging directly to syslog</span>
<span class="lineno">10</span> <span class="nv">LOGDEST</span><span class="o">=</span><span class="s1">&#39;console&#39;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c"># this may be overkill. A time/datestamp or even standard path may be more</span>
<span class="lineno">13</span> <span class="c"># suitable.</span>
<span class="lineno">14</span> <span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>uuidgen<span class="sb">`</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c"># SSH credentials setup</span>
<span class="lineno">17</span> <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$HOME</span>/.ssh <span class="o">]]</span>; <span class="k">then</span>
<span class="lineno">18</span> <span class="k">    </span>mkdir --mode<span class="o">=</span>700 <span class="nv">$HOME</span>/.ssh
<span class="lineno">19</span> <span class="k">fi</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="c"># Stash $HOME/.ssh/config if it already exists. We&#39;ll put it back when we&#39;re</span>
<span class="lineno">22</span> <span class="c"># finished.</span>
<span class="lineno">23</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">24</span> <span class="k">    </span>mv <span class="nv">$HOME</span>/.ssh/config <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config
<span class="lineno">25</span> <span class="k">fi</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="nb">test</span> -x /usr/bin/wget <span class="o">||</span> <span class="nb">exit </span>1
<span class="lineno">28</span> wget -q -O <span class="nv">$HOME</span>/.ssh/config http://autoserver/d-i/bin/puppet_ssh.config
<span class="lineno">29</span> wget -q -O <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa <span class="se">\</span>
<span class="lineno">30</span>            http://autoserver/d-i/bin/puppet_readonly_id_rsa
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="c"># OpenSSH will bork out if the permissions are not exactly right.</span>
<span class="lineno">33</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa
<span class="lineno">34</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="c"># Clone a copy of the puppet manifests</span>
<span class="lineno">37</span> <span class="k">if</span> <span class="o">[</span> ! -d /var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">38</span> <span class="k">    </span>git clone gitlab:puppet.git /var/tmp/puppet/<span class="nv">$UUID</span>
<span class="lineno">39</span> <span class="k">fi</span>
<span class="lineno">40</span> 
<span class="lineno">41</span> <span class="c"># Get any updates to a previously checked out manifest repo</span>
<span class="lineno">42</span> <span class="k">if</span> <span class="o">[</span> -f /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">43</span> <span class="k">    </span>git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">44</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> fetch
<span class="lineno">45</span>     git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">46</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> merge origin/master
<span class="lineno">47</span> <span class="k">fi</span>
<span class="lineno">48</span> 
<span class="lineno">49</span> <span class="c"># Return the users .ssh settings.</span>
<span class="lineno">50</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">51</span> <span class="k">    </span>rm <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">52</span>     mv <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">53</span>     chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">54</span> <span class="k">fi</span>
<span class="lineno">55</span> 
<span class="lineno">56</span> <span class="c"># Finally run puppet. This *can* take a while.</span>
<span class="lineno">57</span> puppet apply --modulepath<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/modules --color <span class="nb">false</span><span class="se">\</span>
<span class="lineno">58</span>        --vardir /var/tmp/puppet/var --confdir /var/tmp/puppet/etc --no-report <span class="se">\</span>
<span class="lineno">59</span>        --logdest <span class="nv">$LOGDEST</span> /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
</code></pre></div>

<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#apt">Apt</a></li>
  <li><a href="#ppas">PPAs</a></li>
  <li><a href="#puppet">Puppet</a></li>
  <li><a href="#tldr">TL;DR</a></li>
</ul>

<h2 id="background">Background</h2>
<hr />

<p>When running puppet on our hosts we were finding that it would take not only far longer than we expected it to but that it was re-applying the creation of PPAs each time. These PPAs are critical for keeping our software up to date so we needed to find a way to keep them from being re-created on each run.</p>

<h2 id="apt">Apt</h2>
<hr />

<p>At Baseblack all of our workstations, render nodes and servers have their software packages, configured and managed via a combination of Puppet and Apt repositories.</p>

<p>We preseed the build of a new host, pointing the installer at the official Ubuntu mirrors to retrieve the packages it requires. There are however many optional packages not yet included as part of universe or multiverse which our users find useful for their day to day work which we include on the system.</p>

<p>For internal software and tools we use Jordan Sissel’s <a href="https://github.com/jordansissel/fpm">fpm</a> to generate Debian packages which can then locally host in a <a href="http://mirrorer.alioth.debian.org/">reprepro</a> managed apt repository.</p>

<p>For those external pieces of software which are not in the official repositories we heavily rely upon Ubuntu’s <a href="https://help.launchpad.net/Packaging/PPA">PPA</a> mechanism for adding additional unofficial packages to the system.</p>

<h2 id="ppas">PPAs</h2>
<hr />

<p>PPAs were developed on top of Launchpad as a means of hosting and distributing software. Some examples of the software which we install using PPAs are; salt for orchestrated tasks, hugin the panorama stitcher and the latest nvidia graphics driver.</p>

<p>The easiest way to add a ppa to the sources list is to use the add-apt-repository command. This takes the ppa’s short name, builds the apt url to access it, stores it in <code>/etc/apt/sources.list.d/*</code> and retrieves its public signing key.</p>

<blockquote>
  <p>add-apt-repository ppa:username/package</p>
</blockquote>

<h2 id="puppet">Puppet</h2>
<hr />

<p>We make use of the puppet-apt manifests put together by evolvingweb.</p>

<blockquote>
  <p>https://github.com/evolvingweb/puppet-apt</p>
</blockquote>

<p>Unfortunately each time puppet was running we were finding that it would not only take longer than we expected, but that the time it took was variable. Often during the middle of the day when our internet connection was more heavily being utilised the runs would take substantially longer.</p>

<p>We quickly saw when inspecting the run logs that on each run the ppas were being re-added into <em>sources.list.d</em>.</p>

<p>Using what little skill I have at writing puppet configurations and from <strong><em>reading</em></strong> the documentation I amended the apt::ppa definition to make use of the <strong>creates =&gt;</strong> parameter for the <strong>exec</strong> action. This parameter causes the action to only be executed if the file which it points towards does not exist at the specified location.</p>

<p>After adding the condition we found that our runs became much shorter and consistent in run time.</p>

<p>Finally here is the amended definition in all of its terrible glory:</p>

<div class="highlight"><pre><code class="puppet">    <span class="k">define</span> <span class="na">apt</span><span class="p">::</span><span class="na">ppa</span><span class="p">()</span> <span class="p">{</span>
        <span class="na">require</span> <span class="na">apt</span>

        <span class="nv">$ppa_prefix</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$name,</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name_repo</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$ppa_prefix</span><span class="p">[</span><span class="s">1</span><span class="p">],</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">0</span><span class="p">]</span>
        <span class="nv">$ppa_repo</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">1</span><span class="p">]</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;apt-update-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span>     <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/aptitude update&quot;</span><span class="p">,</span>
            <span class="na">refreshonly</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="na">creates</span> <span class="o">=&gt;</span> <span class="s">&quot;/etc/apt/sources.list.d/${ppa_name}-${ppa_repo}-${lsbdistcodename}.list&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;add-apt-repository-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span> <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/add-apt-repository ${name}&quot;</span><span class="p">,</span>
            <span class="k">notify</span>  <span class="o">=&gt;</span> <span class="k">Exec</span><span class="p">[</span><span class="s">&quot;apt-update-${name}&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="tldr">TL;DR</h2>
<hr />

<p>Puppet exec has a ‘creates =&gt; somefile’ action. Add it to the exec definition which calls add-apt-repository to make it only run the first time before the file has been created.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    apt<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#current-feature-set">Current Feature Set</a>    <ul>
      <li><a href="#browsing">Browsing</a></li>
      <li><a href="#searching">Searching</a></li>
    </ul>
  </li>
  <li><a href="#future-ideas">Future Ideas</a></li>
  <li><a href="#get-hold-of-it-yourself">Get hold of it yourself</a></li>
  <li><a href="#technical-details">Technical Details</a></li>
</ul>

<h2 id="overview">Overview</h2>

<hr />

<p>A few weeks ago we finished a first draft release of <a href="http://github.com/andrewbunday/reproweb">ReproWeb</a>, a small, light weight apt repository browser. The browser was build out of an increasing need we were finding, to be able to introspect into our main production repository.</p>

<p>Over the course of 1.5 years that repository has grown to the point when the main stable channel contains around 334 individual packages whilst the unstable channel contains a further 149.</p>

<p>Without running apt-cache commands, and munging with our software source lists it was becoming difficult to not only find the name/version of a piece of software, but it was also becoming hard to tell:</p>

<ul>
  <li>When the package was created</li>
  <li>Who created the package</li>
  <li>If the package had a newer version in the unstable channel</li>
  <li>If the package was available in the stable channel</li>
  <li>If the package had been published for all of our supported distributions.</li>
</ul>

<p>Almost all of these tasks can be carried out from a terminal using commands such as <code>apt-get show</code>, but the web interface allows for far quicker navigation, comparison and has already started us asking more questions as our understanding of the data in our repository grows.</p>

<h2 id="current-feature-set">Current Feature Set</h2>

<hr />

<p>At present Reproweb allows a user to perform filters on the content of a repository based on either;</p>

<ul>
  <li>simple string pattern matching against either the package name, version string or codename/component/architecture,</li>
  <li>or by browsing through the hierarchy of the repository from:</li>
</ul>

<blockquote>
  <p>codename -&gt; component -&gt; architecture -&gt; package -&gt; version</p>
</blockquote>

<h3 id="browsing">Browsing</h3>
<hr />

<blockquote>
  <p>Do you find yourself wanting to know more about your repository? Perhaps how many packages are in a particular component? or perhaps you don’t know the structure of your repository and you want to get to know it more intimately?</p>
</blockquote>

<p>These screenshots show:</p>

<ul>
  <li>The root of the repository, listing the currently defined distributions.
Metadata associated with the distribution is also listed along with information such as the components available within the distribtuion and the total number of packages currently published within it.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_07.png" alt="" /></p>

<ul>
  <li>The breadcrumb which is left at the top of the interface as you delve deeper into the repository.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_08.png" alt="" /></p>

<h3 id="searching">Searching</h3>
<hr />

<blockquote>
  <p>Do you have a specific package you are looking for? Do you know it’s name or version and don’t want to have to go browsing around for it?</p>
</blockquote>

<p>The package list shows all of the packages currently available for a given architecture or all of the packages across all of the distributions in the repository. The search box can be used to search through these packages, as you type it will filter out those packages which don’t match.</p>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_05.png" alt="" /></p>

<h2 id="future-ideas">Future Ideas</h2>
<hr />

<p>This is a list of the features which I’d like to add in time.</p>

<ol>
  <li>Make the package view accessable at an point in the browser, so for example
allow listing of packages in a component.</li>
  <li>Complete json endpoints for all urls.</li>
  <li>Renaming or package or version number.</li>
  <li>Listing of unreferrenced versions. Or previous versions which are no longer
available in Releases.gz</li>
  <li>Listing of pre/post install/remove scripts.</li>
</ol>

<h2 id="get-hold-of-it-yourself">Get hold of it yourself</h2>
<hr />

<p>I strongly recommending visiting <a href="http://github.com/andrewbunday/reproweb">http://github.com/andrewbunday/reproweb</a> and start by reading the README and documentation on the repo.</p>

<p>Or for the impatient in life:</p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c"># clone the repository</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> git clone https://github.com/andrewbunday/ReproWeb.git
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="c"># ensure that the cache directory has been created, or that you edit the setting in the configuration before you start up the app.</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> sudo mkdir /var/cache/reproweb
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># start it up</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> python debug-run.py
</code></pre></div>

<h2 id="technical-details">Technical Details</h2>

<hr />

<p>Underneath the hood ReproWeb is built using only a handful of <em>(at the time of writing)</em> actively developed tools.</p>

<p>Development of Reproweb was conciously kept to a tight a deadline. We gave ourselves less than 2 weeks to go from establishing our initial requirements, having looked at the alternatives, to the first releaseable draft.</p>

<p>This drove our decisions behind each of the components we used to build the application.</p>

<ul>
  <li>
    <p><strong>reprepro</strong> - This is the repository management tool which the browser has been designed to be used with. All of the interactions with reprepro are handled through via the 3rd party script reepocheep.py which could be swapped out with an equivalent script which provides the same api.</p>

    <p>Since we were using reprepro already to manage our software package repositories it made complete sense to tailor the app to its strengths.</p>

    <p>The majority of the heavy lifting for the app is handled by calls to reprepro via subprocess and then handling of the returned data.</p>
  </li>
  <li>
    <p><strong>flask</strong> - A small web application backend framework which handles all of the functionality we need for it for this project. Something as feature rich as django would have been more cumbersome that the project required. Other parts of the Flask eco system were utilised, such as jinja2 to handle dynamic page generation.</p>

    <p>This is one of my personally favourite frameworks to use when building these kinds of applications. Having worked previously with django and really having not gotten on well with it I’ve always been attracted to these lighter weight frameworks.</p>

    <p>Another choice a few years ago might have been <a href="http://webpy.org">web.py</a> which truely is a micro framework would have ended up being replaced as it reached its limits a little sooner than flask will.</p>
  </li>
  <li>
    <p><strong>bootstrap</strong> - A very user friendly web front-end framework which handles features such as responsive layout, navbar and general css styling consistency.</p>

    <p>A few years ago if someone had told me that all of the css and jquery plugins I would need to build a webpage/app quickly with little stress I could download and get started with in minutes, I would have laughed and said ‘your sooo funny’. However now Bootstrap does all those things and it has made the lives of non-web developers such as myself far easier.</p>
  </li>
  <li>
    <p><strong>datatables.js</strong> - A damn awesome jquery plugin which completely powers the tabulated, sortable, filterable, paginated list of packages seen in the search view.</p>

    <p>Does what it says on the tin. Credit goes to <a href="http://paulnendick.github.com">@PaulNendick</a> for the find.</p>
  </li>
</ul>
<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#apt">Apt</a></li>
  <li><a href="#ppas">PPAs</a></li>
  <li><a href="#puppet">Puppet</a></li>
  <li><a href="#tldr">TL;DR</a></li>
</ul>

<h2 id="background">Background</h2>
<hr />

<p>When running puppet on our hosts we were finding that it would take not only far longer than we expected it to but that it was re-applying the creation of PPAs each time. These PPAs are critical for keeping our software up to date so we needed to find a way to keep them from being re-created on each run.</p>

<h2 id="apt">Apt</h2>
<hr />

<p>At Baseblack all of our workstations, render nodes and servers have their software packages, configured and managed via a combination of Puppet and Apt repositories.</p>

<p>We preseed the build of a new host, pointing the installer at the official Ubuntu mirrors to retrieve the packages it requires. There are however many optional packages not yet included as part of universe or multiverse which our users find useful for their day to day work which we include on the system.</p>

<p>For internal software and tools we use Jordan Sissel’s <a href="https://github.com/jordansissel/fpm">fpm</a> to generate Debian packages which can then locally host in a <a href="http://mirrorer.alioth.debian.org/">reprepro</a> managed apt repository.</p>

<p>For those external pieces of software which are not in the official repositories we heavily rely upon Ubuntu’s <a href="https://help.launchpad.net/Packaging/PPA">PPA</a> mechanism for adding additional unofficial packages to the system.</p>

<h2 id="ppas">PPAs</h2>
<hr />

<p>PPAs were developed on top of Launchpad as a means of hosting and distributing software. Some examples of the software which we install using PPAs are; salt for orchestrated tasks, hugin the panorama stitcher and the latest nvidia graphics driver.</p>

<p>The easiest way to add a ppa to the sources list is to use the add-apt-repository command. This takes the ppa’s short name, builds the apt url to access it, stores it in <code>/etc/apt/sources.list.d/*</code> and retrieves its public signing key.</p>

<blockquote>
  <p>add-apt-repository ppa:username/package</p>
</blockquote>

<h2 id="puppet">Puppet</h2>
<hr />

<p>We make use of the puppet-apt manifests put together by evolvingweb.</p>

<blockquote>
  <p>https://github.com/evolvingweb/puppet-apt</p>
</blockquote>

<p>Unfortunately each time puppet was running we were finding that it would not only take longer than we expected, but that the time it took was variable. Often during the middle of the day when our internet connection was more heavily being utilised the runs would take substantially longer.</p>

<p>We quickly saw when inspecting the run logs that on each run the ppas were being re-added into <em>sources.list.d</em>.</p>

<p>Using what little skill I have at writing puppet configurations and from <strong><em>reading</em></strong> the documentation I amended the apt::ppa definition to make use of the <strong>creates =&gt;</strong> parameter for the <strong>exec</strong> action. This parameter causes the action to only be executed if the file which it points towards does not exist at the specified location.</p>

<p>After adding the condition we found that our runs became much shorter and consistent in run time.</p>

<p>Finally here is the amended definition in all of its terrible glory:</p>

<div class="highlight"><pre><code class="puppet">    <span class="k">define</span> <span class="na">apt</span><span class="p">::</span><span class="na">ppa</span><span class="p">()</span> <span class="p">{</span>
        <span class="na">require</span> <span class="na">apt</span>

        <span class="nv">$ppa_prefix</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$name,</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name_repo</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$ppa_prefix</span><span class="p">[</span><span class="s">1</span><span class="p">],</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">0</span><span class="p">]</span>
        <span class="nv">$ppa_repo</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">1</span><span class="p">]</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;apt-update-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span>     <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/aptitude update&quot;</span><span class="p">,</span>
            <span class="na">refreshonly</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="na">creates</span> <span class="o">=&gt;</span> <span class="s">&quot;/etc/apt/sources.list.d/${ppa_name}-${ppa_repo}-${lsbdistcodename}.list&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;add-apt-repository-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span> <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/add-apt-repository ${name}&quot;</span><span class="p">,</span>
            <span class="k">notify</span>  <span class="o">=&gt;</span> <span class="k">Exec</span><span class="p">[</span><span class="s">&quot;apt-update-${name}&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="tldr">TL;DR</h2>
<hr />

<p>Puppet exec has a ‘creates =&gt; somefile’ action. Add it to the exec definition which calls add-apt-repository to make it only run the first time before the file has been created.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    ppa<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#apt">Apt</a></li>
  <li><a href="#ppas">PPAs</a></li>
  <li><a href="#puppet">Puppet</a></li>
  <li><a href="#tldr">TL;DR</a></li>
</ul>

<h2 id="background">Background</h2>
<hr />

<p>When running puppet on our hosts we were finding that it would take not only far longer than we expected it to but that it was re-applying the creation of PPAs each time. These PPAs are critical for keeping our software up to date so we needed to find a way to keep them from being re-created on each run.</p>

<h2 id="apt">Apt</h2>
<hr />

<p>At Baseblack all of our workstations, render nodes and servers have their software packages, configured and managed via a combination of Puppet and Apt repositories.</p>

<p>We preseed the build of a new host, pointing the installer at the official Ubuntu mirrors to retrieve the packages it requires. There are however many optional packages not yet included as part of universe or multiverse which our users find useful for their day to day work which we include on the system.</p>

<p>For internal software and tools we use Jordan Sissel’s <a href="https://github.com/jordansissel/fpm">fpm</a> to generate Debian packages which can then locally host in a <a href="http://mirrorer.alioth.debian.org/">reprepro</a> managed apt repository.</p>

<p>For those external pieces of software which are not in the official repositories we heavily rely upon Ubuntu’s <a href="https://help.launchpad.net/Packaging/PPA">PPA</a> mechanism for adding additional unofficial packages to the system.</p>

<h2 id="ppas">PPAs</h2>
<hr />

<p>PPAs were developed on top of Launchpad as a means of hosting and distributing software. Some examples of the software which we install using PPAs are; salt for orchestrated tasks, hugin the panorama stitcher and the latest nvidia graphics driver.</p>

<p>The easiest way to add a ppa to the sources list is to use the add-apt-repository command. This takes the ppa’s short name, builds the apt url to access it, stores it in <code>/etc/apt/sources.list.d/*</code> and retrieves its public signing key.</p>

<blockquote>
  <p>add-apt-repository ppa:username/package</p>
</blockquote>

<h2 id="puppet">Puppet</h2>
<hr />

<p>We make use of the puppet-apt manifests put together by evolvingweb.</p>

<blockquote>
  <p>https://github.com/evolvingweb/puppet-apt</p>
</blockquote>

<p>Unfortunately each time puppet was running we were finding that it would not only take longer than we expected, but that the time it took was variable. Often during the middle of the day when our internet connection was more heavily being utilised the runs would take substantially longer.</p>

<p>We quickly saw when inspecting the run logs that on each run the ppas were being re-added into <em>sources.list.d</em>.</p>

<p>Using what little skill I have at writing puppet configurations and from <strong><em>reading</em></strong> the documentation I amended the apt::ppa definition to make use of the <strong>creates =&gt;</strong> parameter for the <strong>exec</strong> action. This parameter causes the action to only be executed if the file which it points towards does not exist at the specified location.</p>

<p>After adding the condition we found that our runs became much shorter and consistent in run time.</p>

<p>Finally here is the amended definition in all of its terrible glory:</p>

<div class="highlight"><pre><code class="puppet">    <span class="k">define</span> <span class="na">apt</span><span class="p">::</span><span class="na">ppa</span><span class="p">()</span> <span class="p">{</span>
        <span class="na">require</span> <span class="na">apt</span>

        <span class="nv">$ppa_prefix</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$name,</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name_repo</span> <span class="o">=</span> <span class="k">split</span><span class="p">(</span><span class="nv">$ppa_prefix</span><span class="p">[</span><span class="s">1</span><span class="p">],</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="nv">$ppa_name</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">0</span><span class="p">]</span>
        <span class="nv">$ppa_repo</span> <span class="o">=</span> <span class="nv">$ppa_name_repo</span><span class="p">[</span><span class="s">1</span><span class="p">]</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;apt-update-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span>     <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/aptitude update&quot;</span><span class="p">,</span>
            <span class="na">refreshonly</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
            <span class="na">creates</span> <span class="o">=&gt;</span> <span class="s">&quot;/etc/apt/sources.list.d/${ppa_name}-${ppa_repo}-${lsbdistcodename}.list&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">exec</span> <span class="p">{</span> <span class="s">&quot;add-apt-repository-${name}&quot;</span><span class="p">:</span>
            <span class="na">command</span> <span class="o">=&gt;</span> <span class="s">&quot;/usr/bin/add-apt-repository ${name}&quot;</span><span class="p">,</span>
            <span class="k">notify</span>  <span class="o">=&gt;</span> <span class="k">Exec</span><span class="p">[</span><span class="s">&quot;apt-update-${name}&quot;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="tldr">TL;DR</h2>
<hr />

<p>Puppet exec has a ‘creates =&gt; somefile’ action. Add it to the exec definition which calls add-apt-repository to make it only run the first time before the file has been created.</p>

    {}
</div>
<hr/>

<div class="row-fluid">
    panorama<p><img src="/assets/photostream/2012-10-17_08.06.52.jpg" /></p>

    {}
</div>
<hr/>

<div class="row-fluid">
    photo<p><img src="/assets/photostream/2012-10-17_08.06.52.jpg" /></p>

    {}
</div>
<hr/>

<div class="row-fluid">
    proxmox<p>Today I’m happy to have finished up work on a small python wrapper for Proxmox’s rest based API. We’ve called it <a href="http://github.com/baseblack/proxmoxia">Proxmoxia</a>.</p>

<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#creating-proxmoxia">Creating Proxmoxia</a></li>
  <li><a href="#whats-next">Whats Next?</a></li>
  <li><a href="#finally-some-examples">Finally Some Examples</a></li>
</ul>

<h2 id="background">Background</h2>
<hr />

<p>For those who don’t know, <a href="http://pve.proxmox.com/wiki/Main_Page">Proxmox</a> is an open source server virtualization platform which allows you to create and manage any number of virtual machines based on either KVM or OpenVZ.</p>

<p>At Baseblack we utilise Proxmox to provide us with the majority of our central infrastructure. For example we run a pair of DNS servers, an almost countless number of license servers and farm manager all as openvz containers. Doing this provides us with a far higher level of service since if any one of our virtualization nodes go down we can quickly and pretty painlessly re-start the downed services on one of the other nodes whilst we work outs whats happening.</p>

<p>An area of active development for us is the automation of builds of new software packages for deployment onto our workstations, render nodes and virtual hosts.</p>

<blockquote>
  <p><em>This is where Proxmoxia comes in.</em></p>
</blockquote>

<p>Until recently anytime we’ve needed to spin up a new virtual server, we’ve needed to login to the web interface and manually create a new instance. Not only is this tedious and time consuming, but it can also lead to the occasional mistake.</p>

<p>We knew that our plans for automated builds, and testing of packages would involve us spinning up more and more sacrificial virtual machines which we could use as testing/build bots, each being discarded once they had completed their assigned tasks.</p>

<h2 id="creating-proxmoxia">Creating Proxmoxia</h2>
<hr />

<p>After a short burst of <em>‘Spanish Flea’</em> our  preferred google search background music we found that the majority of the existing implementations of wrappers for the rest API had been in languages we either weren’t keen on or flat out refused to use.</p>

<blockquote>
  <p><em>Perl, Java, PHP need not apply</em></p>
</blockquote>

<p>Unfortunately I didn’t come across PyProxmox <em>(a major omission of mine)</em> until I’d already spent the better part of a day planning on how to make proxmoxia. And by then I well and truly had the bit between my teeth.</p>

<p>I wanted to create a library which followed a few simple rules:</p>

<ol>
  <li>It should ‘feel’ pythonic.</li>
  <li>I wanted the wrapper to extend itself. Or in a few more words; I didn’t want to have to personally write wrapper functions for each and every endpoint and method combination which are currently exposed in the rest api.</li>
</ol>

<p>Personally I don’t like PyProxmox’s implementation for both of these reasons which is why I feel justified in completing Proxmoxia.</p>

<h2 id="whats-next">Whats Next?</h2>
<hr />

<p>We’re going to be using the library as part of our testing suite, creating new VMs off of the back of Jenkins builds. Hopefully it’s going to work out to be really useful.</p>

<h2 id="finally-some-examples">Finally Some Examples</h2>
<hr />

<p>Okay, so here are some examples to show what I’m talking about. Head over to the <a href="http://github.com/baseblack/proxmoxia">github</a> site for the source for these.</p>

<p>First up, Proxmox uses a token based authentication mechanism which must be attached to the headers of each request.</p>

<p>Connect to any node in the cluster and get the auth_token:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">proxmox</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Connector</span><span class="p">(</span><span class="s">&#39;proxmox-1&#39;</span><span class="p">,</span> <span class="mi">8006</span><span class="p">)</span>
<span class="n">auth_token</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_auth_token</span><span class="p">(</span><span class="s">&#39;user@pam&#39;</span><span class="p">,</span> <span class="s">&#39;strawberries&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Next create Proxmox and Node access objects, these are the bread and butter of the library:</p>

<div class="highlight"><pre><code class="python"><span class="n">p</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Proxmox</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s">&#39;proxmox-7&#39;</span><span class="p">)</span>  <span class="c"># this is on a different host.</span>
</code></pre></div>

<p>The library translates its requests into the url equivalent of what you call. So here we request the status on a vm with id number 108:</p>

<div class="highlight"><pre><code class="python"><span class="n">vmid</span> <span class="o">=</span> <span class="mi">108</span>
<span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="n">vmid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
</code></pre></div>

<p>Which is converted to the URL:</p>

<pre><code>http://proxmox-1:8006/api2/json/nodes/proxmox-7/openvz/108/status/current
</code></pre>

<p>Find a vm template filepath and use this as the ostemplate for a new vm you create. And then start it up once it has finished being created:</p>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="c"># find the path for the template you want to use.</span>
<span class="lineno"> 2</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">&#39;vztmpl&#39;</span><span class="p">):</span>
<span class="lineno"> 3</span>     <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*ubuntu-12.04-bb-20121010b_amd64.tar.gz$&#39;</span><span class="p">,</span> <span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">]):</span>
<span class="lineno"> 4</span>         <span class="n">volume</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="c"># create the container, giving it some sensible settings</span>
<span class="lineno"> 7</span> <span class="n">taskid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="o">.</span><span class="n">post</span><span class="p">(</span> <span class="n">ostemplate</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">),</span>
<span class="lineno"> 8</span>                            <span class="n">vmid</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
<span class="lineno"> 9</span>                            <span class="n">hostname</span><span class="o">=</span><span class="s">&#39;test-4&#39;</span><span class="p">,</span>
<span class="lineno">10</span>                            <span class="n">ip_address</span><span class="o">=</span><span class="s">&#39;192.168.123.204&#39;</span><span class="p">,</span>
<span class="lineno">11</span>                            <span class="n">storage</span><span class="o">=</span><span class="s">&#39;local&#39;</span><span class="p">)</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c"># keep an eye on task and see when its completed</span>
<span class="lineno">14</span> <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">()[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;running&#39;</span><span class="p">:</span>
<span class="lineno">15</span>         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c"># print out the logs</span>
<span class="lineno">18</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">():</span>
<span class="lineno">19</span>     <span class="k">print</span> <span class="n">line</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="k">try</span><span class="p">:</span>
<span class="lineno">22</span>     <span class="c"># start up the container</span>
<span class="lineno">23</span>     <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="s">&#39;204&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>
<span class="lineno">24</span> <span class="k">except</span><span class="p">:</span>
<span class="lineno">25</span>     <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unable to start container&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Find if a user exists and create them if they do not:</p>

<div class="highlight"><pre><code class="python"><span class="k">if</span> <span class="s">&#39;andrew.bunday@pve&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="p">()]:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="s">&#39;andrew.bunday@pve&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;test user&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;strawberries&quot;</span><span class="p">)</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    bootstrap<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#current-feature-set">Current Feature Set</a>    <ul>
      <li><a href="#browsing">Browsing</a></li>
      <li><a href="#searching">Searching</a></li>
    </ul>
  </li>
  <li><a href="#future-ideas">Future Ideas</a></li>
  <li><a href="#get-hold-of-it-yourself">Get hold of it yourself</a></li>
  <li><a href="#technical-details">Technical Details</a></li>
</ul>

<h2 id="overview">Overview</h2>

<hr />

<p>A few weeks ago we finished a first draft release of <a href="http://github.com/andrewbunday/reproweb">ReproWeb</a>, a small, light weight apt repository browser. The browser was build out of an increasing need we were finding, to be able to introspect into our main production repository.</p>

<p>Over the course of 1.5 years that repository has grown to the point when the main stable channel contains around 334 individual packages whilst the unstable channel contains a further 149.</p>

<p>Without running apt-cache commands, and munging with our software source lists it was becoming difficult to not only find the name/version of a piece of software, but it was also becoming hard to tell:</p>

<ul>
  <li>When the package was created</li>
  <li>Who created the package</li>
  <li>If the package had a newer version in the unstable channel</li>
  <li>If the package was available in the stable channel</li>
  <li>If the package had been published for all of our supported distributions.</li>
</ul>

<p>Almost all of these tasks can be carried out from a terminal using commands such as <code>apt-get show</code>, but the web interface allows for far quicker navigation, comparison and has already started us asking more questions as our understanding of the data in our repository grows.</p>

<h2 id="current-feature-set">Current Feature Set</h2>

<hr />

<p>At present Reproweb allows a user to perform filters on the content of a repository based on either;</p>

<ul>
  <li>simple string pattern matching against either the package name, version string or codename/component/architecture,</li>
  <li>or by browsing through the hierarchy of the repository from:</li>
</ul>

<blockquote>
  <p>codename -&gt; component -&gt; architecture -&gt; package -&gt; version</p>
</blockquote>

<h3 id="browsing">Browsing</h3>
<hr />

<blockquote>
  <p>Do you find yourself wanting to know more about your repository? Perhaps how many packages are in a particular component? or perhaps you don’t know the structure of your repository and you want to get to know it more intimately?</p>
</blockquote>

<p>These screenshots show:</p>

<ul>
  <li>The root of the repository, listing the currently defined distributions.
Metadata associated with the distribution is also listed along with information such as the components available within the distribtuion and the total number of packages currently published within it.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_07.png" alt="" /></p>

<ul>
  <li>The breadcrumb which is left at the top of the interface as you delve deeper into the repository.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_08.png" alt="" /></p>

<h3 id="searching">Searching</h3>
<hr />

<blockquote>
  <p>Do you have a specific package you are looking for? Do you know it’s name or version and don’t want to have to go browsing around for it?</p>
</blockquote>

<p>The package list shows all of the packages currently available for a given architecture or all of the packages across all of the distributions in the repository. The search box can be used to search through these packages, as you type it will filter out those packages which don’t match.</p>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_05.png" alt="" /></p>

<h2 id="future-ideas">Future Ideas</h2>
<hr />

<p>This is a list of the features which I’d like to add in time.</p>

<ol>
  <li>Make the package view accessable at an point in the browser, so for example
allow listing of packages in a component.</li>
  <li>Complete json endpoints for all urls.</li>
  <li>Renaming or package or version number.</li>
  <li>Listing of unreferrenced versions. Or previous versions which are no longer
available in Releases.gz</li>
  <li>Listing of pre/post install/remove scripts.</li>
</ol>

<h2 id="get-hold-of-it-yourself">Get hold of it yourself</h2>
<hr />

<p>I strongly recommending visiting <a href="http://github.com/andrewbunday/reproweb">http://github.com/andrewbunday/reproweb</a> and start by reading the README and documentation on the repo.</p>

<p>Or for the impatient in life:</p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c"># clone the repository</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> git clone https://github.com/andrewbunday/ReproWeb.git
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="c"># ensure that the cache directory has been created, or that you edit the setting in the configuration before you start up the app.</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> sudo mkdir /var/cache/reproweb
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># start it up</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> python debug-run.py
</code></pre></div>

<h2 id="technical-details">Technical Details</h2>

<hr />

<p>Underneath the hood ReproWeb is built using only a handful of <em>(at the time of writing)</em> actively developed tools.</p>

<p>Development of Reproweb was conciously kept to a tight a deadline. We gave ourselves less than 2 weeks to go from establishing our initial requirements, having looked at the alternatives, to the first releaseable draft.</p>

<p>This drove our decisions behind each of the components we used to build the application.</p>

<ul>
  <li>
    <p><strong>reprepro</strong> - This is the repository management tool which the browser has been designed to be used with. All of the interactions with reprepro are handled through via the 3rd party script reepocheep.py which could be swapped out with an equivalent script which provides the same api.</p>

    <p>Since we were using reprepro already to manage our software package repositories it made complete sense to tailor the app to its strengths.</p>

    <p>The majority of the heavy lifting for the app is handled by calls to reprepro via subprocess and then handling of the returned data.</p>
  </li>
  <li>
    <p><strong>flask</strong> - A small web application backend framework which handles all of the functionality we need for it for this project. Something as feature rich as django would have been more cumbersome that the project required. Other parts of the Flask eco system were utilised, such as jinja2 to handle dynamic page generation.</p>

    <p>This is one of my personally favourite frameworks to use when building these kinds of applications. Having worked previously with django and really having not gotten on well with it I’ve always been attracted to these lighter weight frameworks.</p>

    <p>Another choice a few years ago might have been <a href="http://webpy.org">web.py</a> which truely is a micro framework would have ended up being replaced as it reached its limits a little sooner than flask will.</p>
  </li>
  <li>
    <p><strong>bootstrap</strong> - A very user friendly web front-end framework which handles features such as responsive layout, navbar and general css styling consistency.</p>

    <p>A few years ago if someone had told me that all of the css and jquery plugins I would need to build a webpage/app quickly with little stress I could download and get started with in minutes, I would have laughed and said ‘your sooo funny’. However now Bootstrap does all those things and it has made the lives of non-web developers such as myself far easier.</p>
  </li>
  <li>
    <p><strong>datatables.js</strong> - A damn awesome jquery plugin which completely powers the tabulated, sortable, filterable, paginated list of packages seen in the search view.</p>

    <p>Does what it says on the tin. Credit goes to <a href="http://paulnendick.github.com">@PaulNendick</a> for the find.</p>
  </li>
</ul>

    {}
</div>
<hr/>

<div class="row-fluid">
    flask<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#current-feature-set">Current Feature Set</a>    <ul>
      <li><a href="#browsing">Browsing</a></li>
      <li><a href="#searching">Searching</a></li>
    </ul>
  </li>
  <li><a href="#future-ideas">Future Ideas</a></li>
  <li><a href="#get-hold-of-it-yourself">Get hold of it yourself</a></li>
  <li><a href="#technical-details">Technical Details</a></li>
</ul>

<h2 id="overview">Overview</h2>

<hr />

<p>A few weeks ago we finished a first draft release of <a href="http://github.com/andrewbunday/reproweb">ReproWeb</a>, a small, light weight apt repository browser. The browser was build out of an increasing need we were finding, to be able to introspect into our main production repository.</p>

<p>Over the course of 1.5 years that repository has grown to the point when the main stable channel contains around 334 individual packages whilst the unstable channel contains a further 149.</p>

<p>Without running apt-cache commands, and munging with our software source lists it was becoming difficult to not only find the name/version of a piece of software, but it was also becoming hard to tell:</p>

<ul>
  <li>When the package was created</li>
  <li>Who created the package</li>
  <li>If the package had a newer version in the unstable channel</li>
  <li>If the package was available in the stable channel</li>
  <li>If the package had been published for all of our supported distributions.</li>
</ul>

<p>Almost all of these tasks can be carried out from a terminal using commands such as <code>apt-get show</code>, but the web interface allows for far quicker navigation, comparison and has already started us asking more questions as our understanding of the data in our repository grows.</p>

<h2 id="current-feature-set">Current Feature Set</h2>

<hr />

<p>At present Reproweb allows a user to perform filters on the content of a repository based on either;</p>

<ul>
  <li>simple string pattern matching against either the package name, version string or codename/component/architecture,</li>
  <li>or by browsing through the hierarchy of the repository from:</li>
</ul>

<blockquote>
  <p>codename -&gt; component -&gt; architecture -&gt; package -&gt; version</p>
</blockquote>

<h3 id="browsing">Browsing</h3>
<hr />

<blockquote>
  <p>Do you find yourself wanting to know more about your repository? Perhaps how many packages are in a particular component? or perhaps you don’t know the structure of your repository and you want to get to know it more intimately?</p>
</blockquote>

<p>These screenshots show:</p>

<ul>
  <li>The root of the repository, listing the currently defined distributions.
Metadata associated with the distribution is also listed along with information such as the components available within the distribtuion and the total number of packages currently published within it.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_07.png" alt="" /></p>

<ul>
  <li>The breadcrumb which is left at the top of the interface as you delve deeper into the repository.</li>
</ul>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_08.png" alt="" /></p>

<h3 id="searching">Searching</h3>
<hr />

<blockquote>
  <p>Do you have a specific package you are looking for? Do you know it’s name or version and don’t want to have to go browsing around for it?</p>
</blockquote>

<p>The package list shows all of the packages currently available for a given architecture or all of the packages across all of the distributions in the repository. The search box can be used to search through these packages, as you type it will filter out those packages which don’t match.</p>

<p><img src="https://github.com/andrewbunday/ReproWeb/raw/master/documentation/images/image_05.png" alt="" /></p>

<h2 id="future-ideas">Future Ideas</h2>
<hr />

<p>This is a list of the features which I’d like to add in time.</p>

<ol>
  <li>Make the package view accessable at an point in the browser, so for example
allow listing of packages in a component.</li>
  <li>Complete json endpoints for all urls.</li>
  <li>Renaming or package or version number.</li>
  <li>Listing of unreferrenced versions. Or previous versions which are no longer
available in Releases.gz</li>
  <li>Listing of pre/post install/remove scripts.</li>
</ol>

<h2 id="get-hold-of-it-yourself">Get hold of it yourself</h2>
<hr />

<p>I strongly recommending visiting <a href="http://github.com/andrewbunday/reproweb">http://github.com/andrewbunday/reproweb</a> and start by reading the README and documentation on the repo.</p>

<p>Or for the impatient in life:</p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c"># clone the repository</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> git clone https://github.com/andrewbunday/ReproWeb.git
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="c"># ensure that the cache directory has been created, or that you edit the setting in the configuration before you start up the app.</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> sudo mkdir /var/cache/reproweb
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># start it up</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> python debug-run.py
</code></pre></div>

<h2 id="technical-details">Technical Details</h2>

<hr />

<p>Underneath the hood ReproWeb is built using only a handful of <em>(at the time of writing)</em> actively developed tools.</p>

<p>Development of Reproweb was conciously kept to a tight a deadline. We gave ourselves less than 2 weeks to go from establishing our initial requirements, having looked at the alternatives, to the first releaseable draft.</p>

<p>This drove our decisions behind each of the components we used to build the application.</p>

<ul>
  <li>
    <p><strong>reprepro</strong> - This is the repository management tool which the browser has been designed to be used with. All of the interactions with reprepro are handled through via the 3rd party script reepocheep.py which could be swapped out with an equivalent script which provides the same api.</p>

    <p>Since we were using reprepro already to manage our software package repositories it made complete sense to tailor the app to its strengths.</p>

    <p>The majority of the heavy lifting for the app is handled by calls to reprepro via subprocess and then handling of the returned data.</p>
  </li>
  <li>
    <p><strong>flask</strong> - A small web application backend framework which handles all of the functionality we need for it for this project. Something as feature rich as django would have been more cumbersome that the project required. Other parts of the Flask eco system were utilised, such as jinja2 to handle dynamic page generation.</p>

    <p>This is one of my personally favourite frameworks to use when building these kinds of applications. Having worked previously with django and really having not gotten on well with it I’ve always been attracted to these lighter weight frameworks.</p>

    <p>Another choice a few years ago might have been <a href="http://webpy.org">web.py</a> which truely is a micro framework would have ended up being replaced as it reached its limits a little sooner than flask will.</p>
  </li>
  <li>
    <p><strong>bootstrap</strong> - A very user friendly web front-end framework which handles features such as responsive layout, navbar and general css styling consistency.</p>

    <p>A few years ago if someone had told me that all of the css and jquery plugins I would need to build a webpage/app quickly with little stress I could download and get started with in minutes, I would have laughed and said ‘your sooo funny’. However now Bootstrap does all those things and it has made the lives of non-web developers such as myself far easier.</p>
  </li>
  <li>
    <p><strong>datatables.js</strong> - A damn awesome jquery plugin which completely powers the tabulated, sortable, filterable, paginated list of packages seen in the search view.</p>

    <p>Does what it says on the tin. Credit goes to <a href="http://paulnendick.github.com">@PaulNendick</a> for the find.</p>
  </li>
</ul>

    {}
</div>
<hr/>

<div class="row-fluid">
    bash<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#running-masterless">Running Masterless</a></li>
  <li><a href="#an-example-wrapper-script">An Example Wrapper Script</a></li>
</ul>

<h3 id="background">Background</h3>

<hr />

<p>Typically the easiest way to run puppet is to use the default master and agent
mechanism.</p>

<p>When you run puppet using a master the only way to switch between
different sets of manifests/modules is to use environments. If  you setup puppet
correctly these can allow you to pick and choose which environment you want to
use on a given run, and/or for a given node.</p>

<p>Unfortunately there are a few caveats when using environments.</p>

<ul>
  <li>To pick out a particular enviroment for a specific node each time you ideally
should be using an ENC. Once you setup your enviroment == node relationship it’ll
stick for each run.</li>
  <li>
    <p>If you are not using an ENC, since this is another server which you don’t want
to have to maintain then you are requried to specify the environment to use
via the commandline. For example:</p>

    <blockquote>
      <p><code>puppet agent --test --environment canary_maya_001</code></p>
    </blockquote>
  </li>
  <li>Each environment will need to have a different manifest/modulepath defined and
located in your puppet manifests.</li>
</ul>

<h3 id="running-masterless">Running Masterless</h3>

<hr />

<p>Another way of running puppet is to setup it up in in a masterless mode. Here we
instead checkout a copy of our manifest from a central repository and run puppet
directly against it.</p>

<p>Whilst you gain the advantage of not needing a master, and of being able to split
environments more easily with branches (this can be done with the master but requires
multiple checkouts of the puppet repository). You do loose out on a few features
of puppet, such as:</p>

<ul>
  <li>Reports, these really don’t work as well.</li>
  <li>StoreConfigs is probably the biggest feature loss although you should be able
to solve the problems you would have used it for in other ways (SSHFP for example
when handling new server certificates).</li>
  <li>To use a particular environment on a node it becomes easier to create branches
of your manifests/modules and then checkout the branch you want on the node
just before you execute puppet. This still means you have multiple ‘copies’ of
files, but managing them tends to be easier via standard git branch&amp;merge tools.</li>
</ul>

<h3 id="an-example-wrapper-script">An Example Wrapper Script</h3>

<hr />

<p>The steps involved in running masterless are slightly more cumbersome than
running with a master. In particular if you use a git server such as gitolite
then you need to ensure that you have credentials setup which allow you to read
from the repository.</p>

<p>For this we’re using a locally served ssh config file and private rsa id which
the config file informs ssh to use to identifty ourselves when we contact our
gitolite host.</p>

<p><em>served with a pinch of salt</em></p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c">#!/usr/bin/env bash</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c"># check if sudo has been used or user is root</span>
<span class="lineno"> 4</span> <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${SUDO_USER}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${USER}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="lineno"> 5</span> <span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Fail: Only root can execute puppet&quot;</span>
<span class="lineno"> 6</span>     <span class="nb">exit </span>1
<span class="lineno"> 7</span> <span class="k">fi</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># change to &#39;syslog&#39; to redirect puppet&#39;s internal logging directly to syslog</span>
<span class="lineno">10</span> <span class="nv">LOGDEST</span><span class="o">=</span><span class="s1">&#39;console&#39;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c"># this may be overkill. A time/datestamp or even standard path may be more</span>
<span class="lineno">13</span> <span class="c"># suitable.</span>
<span class="lineno">14</span> <span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>uuidgen<span class="sb">`</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c"># SSH credentials setup</span>
<span class="lineno">17</span> <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$HOME</span>/.ssh <span class="o">]]</span>; <span class="k">then</span>
<span class="lineno">18</span> <span class="k">    </span>mkdir --mode<span class="o">=</span>700 <span class="nv">$HOME</span>/.ssh
<span class="lineno">19</span> <span class="k">fi</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="c"># Stash $HOME/.ssh/config if it already exists. We&#39;ll put it back when we&#39;re</span>
<span class="lineno">22</span> <span class="c"># finished.</span>
<span class="lineno">23</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">24</span> <span class="k">    </span>mv <span class="nv">$HOME</span>/.ssh/config <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config
<span class="lineno">25</span> <span class="k">fi</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="nb">test</span> -x /usr/bin/wget <span class="o">||</span> <span class="nb">exit </span>1
<span class="lineno">28</span> wget -q -O <span class="nv">$HOME</span>/.ssh/config http://autoserver/d-i/bin/puppet_ssh.config
<span class="lineno">29</span> wget -q -O <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa <span class="se">\</span>
<span class="lineno">30</span>            http://autoserver/d-i/bin/puppet_readonly_id_rsa
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="c"># OpenSSH will bork out if the permissions are not exactly right.</span>
<span class="lineno">33</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa
<span class="lineno">34</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="c"># Clone a copy of the puppet manifests</span>
<span class="lineno">37</span> <span class="k">if</span> <span class="o">[</span> ! -d /var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">38</span> <span class="k">    </span>git clone gitlab:puppet.git /var/tmp/puppet/<span class="nv">$UUID</span>
<span class="lineno">39</span> <span class="k">fi</span>
<span class="lineno">40</span> 
<span class="lineno">41</span> <span class="c"># Get any updates to a previously checked out manifest repo</span>
<span class="lineno">42</span> <span class="k">if</span> <span class="o">[</span> -f /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">43</span> <span class="k">    </span>git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">44</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> fetch
<span class="lineno">45</span>     git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">46</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> merge origin/master
<span class="lineno">47</span> <span class="k">fi</span>
<span class="lineno">48</span> 
<span class="lineno">49</span> <span class="c"># Return the users .ssh settings.</span>
<span class="lineno">50</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">51</span> <span class="k">    </span>rm <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">52</span>     mv <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">53</span>     chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">54</span> <span class="k">fi</span>
<span class="lineno">55</span> 
<span class="lineno">56</span> <span class="c"># Finally run puppet. This *can* take a while.</span>
<span class="lineno">57</span> puppet apply --modulepath<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/modules --color <span class="nb">false</span><span class="se">\</span>
<span class="lineno">58</span>        --vardir /var/tmp/puppet/var --confdir /var/tmp/puppet/etc --no-report <span class="se">\</span>
<span class="lineno">59</span>        --logdest <span class="nv">$LOGDEST</span> /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    masterless<h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#running-masterless">Running Masterless</a></li>
  <li><a href="#an-example-wrapper-script">An Example Wrapper Script</a></li>
</ul>

<h3 id="background">Background</h3>

<hr />

<p>Typically the easiest way to run puppet is to use the default master and agent
mechanism.</p>

<p>When you run puppet using a master the only way to switch between
different sets of manifests/modules is to use environments. If  you setup puppet
correctly these can allow you to pick and choose which environment you want to
use on a given run, and/or for a given node.</p>

<p>Unfortunately there are a few caveats when using environments.</p>

<ul>
  <li>To pick out a particular enviroment for a specific node each time you ideally
should be using an ENC. Once you setup your enviroment == node relationship it’ll
stick for each run.</li>
  <li>
    <p>If you are not using an ENC, since this is another server which you don’t want
to have to maintain then you are requried to specify the environment to use
via the commandline. For example:</p>

    <blockquote>
      <p><code>puppet agent --test --environment canary_maya_001</code></p>
    </blockquote>
  </li>
  <li>Each environment will need to have a different manifest/modulepath defined and
located in your puppet manifests.</li>
</ul>

<h3 id="running-masterless">Running Masterless</h3>

<hr />

<p>Another way of running puppet is to setup it up in in a masterless mode. Here we
instead checkout a copy of our manifest from a central repository and run puppet
directly against it.</p>

<p>Whilst you gain the advantage of not needing a master, and of being able to split
environments more easily with branches (this can be done with the master but requires
multiple checkouts of the puppet repository). You do loose out on a few features
of puppet, such as:</p>

<ul>
  <li>Reports, these really don’t work as well.</li>
  <li>StoreConfigs is probably the biggest feature loss although you should be able
to solve the problems you would have used it for in other ways (SSHFP for example
when handling new server certificates).</li>
  <li>To use a particular environment on a node it becomes easier to create branches
of your manifests/modules and then checkout the branch you want on the node
just before you execute puppet. This still means you have multiple ‘copies’ of
files, but managing them tends to be easier via standard git branch&amp;merge tools.</li>
</ul>

<h3 id="an-example-wrapper-script">An Example Wrapper Script</h3>

<hr />

<p>The steps involved in running masterless are slightly more cumbersome than
running with a master. In particular if you use a git server such as gitolite
then you need to ensure that you have credentials setup which allow you to read
from the repository.</p>

<p>For this we’re using a locally served ssh config file and private rsa id which
the config file informs ssh to use to identifty ourselves when we contact our
gitolite host.</p>

<p><em>served with a pinch of salt</em></p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c">#!/usr/bin/env bash</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c"># check if sudo has been used or user is root</span>
<span class="lineno"> 4</span> <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${SUDO_USER}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${USER}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="lineno"> 5</span> <span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Fail: Only root can execute puppet&quot;</span>
<span class="lineno"> 6</span>     <span class="nb">exit </span>1
<span class="lineno"> 7</span> <span class="k">fi</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># change to &#39;syslog&#39; to redirect puppet&#39;s internal logging directly to syslog</span>
<span class="lineno">10</span> <span class="nv">LOGDEST</span><span class="o">=</span><span class="s1">&#39;console&#39;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c"># this may be overkill. A time/datestamp or even standard path may be more</span>
<span class="lineno">13</span> <span class="c"># suitable.</span>
<span class="lineno">14</span> <span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>uuidgen<span class="sb">`</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c"># SSH credentials setup</span>
<span class="lineno">17</span> <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$HOME</span>/.ssh <span class="o">]]</span>; <span class="k">then</span>
<span class="lineno">18</span> <span class="k">    </span>mkdir --mode<span class="o">=</span>700 <span class="nv">$HOME</span>/.ssh
<span class="lineno">19</span> <span class="k">fi</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="c"># Stash $HOME/.ssh/config if it already exists. We&#39;ll put it back when we&#39;re</span>
<span class="lineno">22</span> <span class="c"># finished.</span>
<span class="lineno">23</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">24</span> <span class="k">    </span>mv <span class="nv">$HOME</span>/.ssh/config <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config
<span class="lineno">25</span> <span class="k">fi</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="nb">test</span> -x /usr/bin/wget <span class="o">||</span> <span class="nb">exit </span>1
<span class="lineno">28</span> wget -q -O <span class="nv">$HOME</span>/.ssh/config http://autoserver/d-i/bin/puppet_ssh.config
<span class="lineno">29</span> wget -q -O <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa <span class="se">\</span>
<span class="lineno">30</span>            http://autoserver/d-i/bin/puppet_readonly_id_rsa
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="c"># OpenSSH will bork out if the permissions are not exactly right.</span>
<span class="lineno">33</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa
<span class="lineno">34</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="c"># Clone a copy of the puppet manifests</span>
<span class="lineno">37</span> <span class="k">if</span> <span class="o">[</span> ! -d /var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">38</span> <span class="k">    </span>git clone gitlab:puppet.git /var/tmp/puppet/<span class="nv">$UUID</span>
<span class="lineno">39</span> <span class="k">fi</span>
<span class="lineno">40</span> 
<span class="lineno">41</span> <span class="c"># Get any updates to a previously checked out manifest repo</span>
<span class="lineno">42</span> <span class="k">if</span> <span class="o">[</span> -f /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">43</span> <span class="k">    </span>git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">44</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> fetch
<span class="lineno">45</span>     git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">46</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> merge origin/master
<span class="lineno">47</span> <span class="k">fi</span>
<span class="lineno">48</span> 
<span class="lineno">49</span> <span class="c"># Return the users .ssh settings.</span>
<span class="lineno">50</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="o">]</span>; <span class="k">then</span>
<span class="lineno">51</span> <span class="k">    </span>rm <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">52</span>     mv <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">53</span>     chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">54</span> <span class="k">fi</span>
<span class="lineno">55</span> 
<span class="lineno">56</span> <span class="c"># Finally run puppet. This *can* take a while.</span>
<span class="lineno">57</span> puppet apply --modulepath<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/modules --color <span class="nb">false</span><span class="se">\</span>
<span class="lineno">58</span>        --vardir /var/tmp/puppet/var --confdir /var/tmp/puppet/etc --no-report <span class="se">\</span>
<span class="lineno">59</span>        --logdest <span class="nv">$LOGDEST</span> /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
</code></pre></div>


    {}
</div>
<hr/>

<div class="row-fluid">
    PIL<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#backstory">Backstory</a></li>
  <li><a href="#example">Example</a></li>
  <li><a href="#quick-explanation">Quick Explanation</a></li>
  <li><a href="#the-code">The Code</a></li>
</ul>

<h3 id="backstory">Backstory</h3>

<p>This little example came about following a request from a supervisor who was remembering the ‘old’ days of when they used to use Shake and how they used to have a little histogram overlay which they could apply over the top of their comp during tech checks to quickly see if there where were any illegal values or obvious clipping occurring.</p>

<p>Unfortunately Nuke doesn’t have anything out of the box which quite matches this behaviour, and whilst the histogram Node is lacking, it is not a big enough bug bear to cause anyone to really want to ever launch Shake again.</p>

<p><em>That is a minor lie, the 2D tracker definitely is still good enough when compared to the one in Nuke that we still catch Compositors firing it up for a quick track.</em></p>

<h3 id="example">Example</h3>

<p><img src="https://raw.github.com/andrewbunday/PyHistogram/master/reference/example.png" alt="" /></p>

<h3 id="quick-explanation">Quick Explanation</h3>

<p>So here’s whats happening:</p>

<ol>
  <li>PIL.Image is used to open the input image, in this case a jpg but other formats could be used, and the Image class replaced with a reader for your particular image. The only important feature of the reader class is that it must be capable of formatting the pixel data as an array compatible with pylab.array().</li>
  <li>Each of the channels is extracted from the image for separate manipulation.</li>
  <li>We start a new figure, this initialises pylab.</li>
  <li>For each channel we compute a histogram of the pixel values. These will be displayed, overlaid on the figure, but will not be scaled to fit nicely within the bounds of our reference image.</li>
  <li>We compute the scale to apply to the x/y axis by finding out the maximum number of samples for each channel (X) and the maximum value of each sample (Y).</li>
  <li>All of the image data is displayed, and we modify the labels and properties of the graph axis to improve their legibility. </li>
</ol>

<h3 id="the-code">The Code</h3>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">pylab</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">file_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/../reference/aa_van_and_bike.jpg&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="lineno"> 6</span> <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">255</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="n">im</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="n">blue</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">b</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">11</span> <span class="n">green</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">12</span> <span class="n">red</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">r</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">15</span> <span class="n">b_n</span><span class="p">,</span> <span class="n">b_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">16</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">g_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">17</span> <span class="n">r_n</span><span class="p">,</span> <span class="n">r_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="n">max_samples</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">b_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">g_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_n</span><span class="p">)])</span>
<span class="lineno">20</span> <span class="n">max_density</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">b_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">g_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r_n</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="lineno">21</span> <span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">max_samples</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">max_density</span><span class="p">])</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="lineno">24</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="lineno">25</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">26</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">27</span> <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Saturation (0-1)&#39;</span><span class="p">)</span>
<span class="lineno">28</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Density&#39;</span><span class="p">)</span>
<span class="lineno">29</span> 
<span class="lineno">30</span> <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Color Density Analysis of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno">31</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

    {}
</div>
<hr/>

<div class="row-fluid">
    pylab<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#backstory">Backstory</a></li>
  <li><a href="#example">Example</a></li>
  <li><a href="#quick-explanation">Quick Explanation</a></li>
  <li><a href="#the-code">The Code</a></li>
</ul>

<h3 id="backstory">Backstory</h3>

<p>This little example came about following a request from a supervisor who was remembering the ‘old’ days of when they used to use Shake and how they used to have a little histogram overlay which they could apply over the top of their comp during tech checks to quickly see if there where were any illegal values or obvious clipping occurring.</p>

<p>Unfortunately Nuke doesn’t have anything out of the box which quite matches this behaviour, and whilst the histogram Node is lacking, it is not a big enough bug bear to cause anyone to really want to ever launch Shake again.</p>

<p><em>That is a minor lie, the 2D tracker definitely is still good enough when compared to the one in Nuke that we still catch Compositors firing it up for a quick track.</em></p>

<h3 id="example">Example</h3>

<p><img src="https://raw.github.com/andrewbunday/PyHistogram/master/reference/example.png" alt="" /></p>

<h3 id="quick-explanation">Quick Explanation</h3>

<p>So here’s whats happening:</p>

<ol>
  <li>PIL.Image is used to open the input image, in this case a jpg but other formats could be used, and the Image class replaced with a reader for your particular image. The only important feature of the reader class is that it must be capable of formatting the pixel data as an array compatible with pylab.array().</li>
  <li>Each of the channels is extracted from the image for separate manipulation.</li>
  <li>We start a new figure, this initialises pylab.</li>
  <li>For each channel we compute a histogram of the pixel values. These will be displayed, overlaid on the figure, but will not be scaled to fit nicely within the bounds of our reference image.</li>
  <li>We compute the scale to apply to the x/y axis by finding out the maximum number of samples for each channel (X) and the maximum value of each sample (Y).</li>
  <li>All of the image data is displayed, and we modify the labels and properties of the graph axis to improve their legibility. </li>
</ol>

<h3 id="the-code">The Code</h3>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">pylab</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">file_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/../reference/aa_van_and_bike.jpg&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="lineno"> 6</span> <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">255</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="n">im</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="n">blue</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">b</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">11</span> <span class="n">green</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">12</span> <span class="n">red</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">r</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">15</span> <span class="n">b_n</span><span class="p">,</span> <span class="n">b_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">16</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">g_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">17</span> <span class="n">r_n</span><span class="p">,</span> <span class="n">r_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="n">max_samples</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">b_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">g_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_n</span><span class="p">)])</span>
<span class="lineno">20</span> <span class="n">max_density</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">b_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">g_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r_n</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="lineno">21</span> <span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">max_samples</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">max_density</span><span class="p">])</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="lineno">24</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="lineno">25</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">26</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">27</span> <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Saturation (0-1)&#39;</span><span class="p">)</span>
<span class="lineno">28</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Density&#39;</span><span class="p">)</span>
<span class="lineno">29</span> 
<span class="lineno">30</span> <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Color Density Analysis of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno">31</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

    {}
</div>
<hr/>

<div class="row-fluid">
    image<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#backstory">Backstory</a></li>
  <li><a href="#example">Example</a></li>
  <li><a href="#quick-explanation">Quick Explanation</a></li>
  <li><a href="#the-code">The Code</a></li>
</ul>

<h3 id="backstory">Backstory</h3>

<p>This little example came about following a request from a supervisor who was remembering the ‘old’ days of when they used to use Shake and how they used to have a little histogram overlay which they could apply over the top of their comp during tech checks to quickly see if there where were any illegal values or obvious clipping occurring.</p>

<p>Unfortunately Nuke doesn’t have anything out of the box which quite matches this behaviour, and whilst the histogram Node is lacking, it is not a big enough bug bear to cause anyone to really want to ever launch Shake again.</p>

<p><em>That is a minor lie, the 2D tracker definitely is still good enough when compared to the one in Nuke that we still catch Compositors firing it up for a quick track.</em></p>

<h3 id="example">Example</h3>

<p><img src="https://raw.github.com/andrewbunday/PyHistogram/master/reference/example.png" alt="" /></p>

<h3 id="quick-explanation">Quick Explanation</h3>

<p>So here’s whats happening:</p>

<ol>
  <li>PIL.Image is used to open the input image, in this case a jpg but other formats could be used, and the Image class replaced with a reader for your particular image. The only important feature of the reader class is that it must be capable of formatting the pixel data as an array compatible with pylab.array().</li>
  <li>Each of the channels is extracted from the image for separate manipulation.</li>
  <li>We start a new figure, this initialises pylab.</li>
  <li>For each channel we compute a histogram of the pixel values. These will be displayed, overlaid on the figure, but will not be scaled to fit nicely within the bounds of our reference image.</li>
  <li>We compute the scale to apply to the x/y axis by finding out the maximum number of samples for each channel (X) and the maximum value of each sample (Y).</li>
  <li>All of the image data is displayed, and we modify the labels and properties of the graph axis to improve their legibility. </li>
</ol>

<h3 id="the-code">The Code</h3>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">pylab</span>
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">file_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/../reference/aa_van_and_bike.jpg&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="lineno"> 6</span> <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">255</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="n">im</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="n">blue</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">b</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">11</span> <span class="n">green</span> <span class="o">=</span> <span class="p">[</span> <span class="n">g</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">12</span> <span class="n">red</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">r</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">im</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channel</span> <span class="p">]</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">pylab</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="lineno">15</span> <span class="n">b_n</span><span class="p">,</span> <span class="n">b_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">16</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">g_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">17</span> <span class="n">r_n</span><span class="p">,</span> <span class="n">r_bins</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">aa</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="n">max_samples</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">b_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">g_n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_n</span><span class="p">)])</span>
<span class="lineno">20</span> <span class="n">max_density</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">b_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">g_n</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r_n</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
<span class="lineno">21</span> <span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">max_samples</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">max_density</span><span class="p">])</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="n">pylab</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="lineno">24</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="lineno">25</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">26</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
<span class="lineno">27</span> <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Saturation (0-1)&#39;</span><span class="p">)</span>
<span class="lineno">28</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Density&#39;</span><span class="p">)</span>
<span class="lineno">29</span> 
<span class="lineno">30</span> <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Color Density Analysis of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="lineno">31</span> <span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

    {}
</div>
<hr/>

                        </div>
                    </div>
                </div>
            </div>

            <hr>

<div class="page-header" style="text-align: center">
  <h4>&copy; 2012. All rights reserved <small>All comments are my own and not those of my employer.</small></h4>
</div>



        </div>
     </body>
</html>
