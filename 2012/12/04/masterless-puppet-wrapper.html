<!DOCTYPE html>
<html>
    <head>
        <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Puppet <small>masterless mode wrapper script</small> / Andy Bunday</title>

    <link rel="shortcut icon" href="/assets/img/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/ubuntu.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for andrewbunday.co.uk" href="/rss.xml" />

    <script type="text/javascript" src="/assets/js/jquery.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-772003-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

    </head>
    <body>
        <div class="page">
            <div class="navbar navbar-static-top">
    <div class="navbar-inner main-navbar-inner">
        <div class="container-fluid main-navbar">
            <a class="btn btn-navbar pull-right" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
           </a>

            <div class="nav-collapse pull-right">
                <ul class="nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/posts.html">Posts</a></li>
                    <li><a href="https://github.com/andrewbunday" target="_blank">Github</a></li>
                    <li><a href="http://www.linkedin.com/in/andrewbunday" target="_blank">LinkedIn</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

            <!-- <div class="row"> -->
    <div class="page-header">
        <h3>Andrew Bunday <small>tech notes</small></h3>
    </div>


            <div class="row" id="breadcrumb">
    <ul class="breadcrumb">
      <li><a href="/">home</a> <span class="divider">/</span></li>
      
        <li><a href="/posts.html">posts</a> <span class="divider">/</span></li>
      
      
        <li class="active">puppet <small>masterless mode wrapper script</small></li>
      
    </ul>
</div>


            <div class="container-fluid main-content">
                <div class="row-fluid">
                    <div class="span12 span12-tablet">
                        <div class="row-fluid">
                            <div class="span12">
                                <h1>Puppet <small>masterless mode wrapper script</small></h1>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span8">
                                <p class="muted">Tue 04 Dec 2012</p>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <p><ul id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#running-masterless">Running Masterless</a></li>
  <li><a href="#an-example-wrapper-script">An Example Wrapper Script</a></li>
</ul>

<h3 id="background">Background</h3>
<p>Typically the easiest way to run puppet is to use the default master and agent
mechanism.</p>

<p>When you run puppet using a master the only way to switch between
different sets of manifests/modules is to use environments. If  you setup puppet
correctly these can allow you to pick and choose which environment you want to
use on a given run, and/or for a given node.</p>

<p>Unfortunately there are a few caveats when using environments.</p>

<ul>
  <li>To pick out a particular enviroment for a specific node each time you ideally
should be using an ENC. Once you setup your enviroment == node relationship it’ll
stick for each run.</li>
  <li>
    <p>If you are not using an ENC, since this is another server which you don’t want
to have to maintain then you are requried to specify the environment to use
via the commandline. For example:</p>

    <blockquote>
      <p><code>puppet agent --test --environment canary_maya_001</code></p>
    </blockquote>
  </li>
  <li>Each environment will need to have a different manifest/modulepath defined and
located in your puppet manifests.</li>
</ul>

<h3 id="running-masterless">Running Masterless</h3>
<p>Another way of running puppet is to setup it up in in a masterless mode. Here we
instead checkout a copy of our manifest from a central repository and run puppet
directly against it.</p>

<p>Whilst you gain the advantage of not needing a master, and of being able to split
environments more easily with branches (this can be done with the master but requires
multiple checkouts of the puppet repository). You do loose out on a few features
of puppet, such as:</p>

<ul>
  <li>Reports, these really don’t work as well.</li>
  <li>StoreConfigs is probably the biggest feature loss although you should be able
to solve the problems you would have used it for in other ways (SSHFP for example
when handling new server certificates).</li>
  <li>To use a particular environment on a node it becomes easier to create branches
of your manifests/modules and then checkout the branch you want on the node
just before you execute puppet. This still means you have multiple ‘copies’ of
files, but managing them tends to be easier via standard git branch&amp;merge tools.</li>
</ul>

<h3 id="an-example-wrapper-script">An Example Wrapper Script</h3>
<p>The steps involved in running masterless are slightly more cumbersome than
running with a master. In particular if you use a git server such as gitolite
then you need to ensure that you have credentials setup which allow you to read
from the repository.</p>

<p>For this we’re using a locally served ssh config file and private rsa id which
the config file informs ssh to use to identifty ourselves when we contact our
gitolite host.</p>

<p><em>served with a pinch of salt</em></p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="c"># check if sudo has been used or user is root</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${SUDO_USER}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${USER}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Fail: Only root can execute puppet&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># change to &#39;syslog&#39; to redirect puppet&#39;s internal logging directly to syslog</span>
<span class="nv">LOGDEST</span><span class="o">=</span><span class="s1">&#39;console&#39;</span>

<span class="c"># this may be overkill. A time/datestamp or even standard path may be more</span>
<span class="c"># suitable.</span>
<span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>uuidgen<span class="sb">`</span>

<span class="c"># SSH credentials setup</span>
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$HOME</span>/.ssh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>mkdir --mode<span class="o">=</span>700 <span class="nv">$HOME</span>/.ssh
<span class="k">fi</span>

<span class="c"># Stash $HOME/.ssh/config if it already exists. We&#39;ll put it back when we&#39;re</span>
<span class="c"># finished.</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/config <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>mv <span class="nv">$HOME</span>/.ssh/config <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config
<span class="k">fi</span>

<span class="nb">test</span> -x /usr/bin/wget <span class="o">||</span> <span class="nb">exit </span>1
wget -q -O <span class="nv">$HOME</span>/.ssh/config http://autoserver/d-i/bin/puppet_ssh.config
wget -q -O <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa <span class="se">\</span>
           http://autoserver/d-i/bin/puppet_readonly_id_rsa

<span class="c"># OpenSSH will bork out if the permissions are not exactly right.</span>
chmod 0600 <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa
chmod 0600 <span class="nv">$HOME</span>/.ssh/config

<span class="c"># Clone a copy of the puppet manifests</span>
<span class="k">if</span> <span class="o">[</span> ! -d /var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>git clone gitlab:puppet.git /var/tmp/puppet/<span class="nv">$UUID</span>
<span class="k">fi</span>

<span class="c"># Get any updates to a previously checked out manifest repo</span>
<span class="k">if</span> <span class="o">[</span> -f /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
        --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> fetch
    git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
        --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> merge origin/master
<span class="k">fi</span>

<span class="c"># Return the users .ssh settings.</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm <span class="nv">$HOME</span>/.ssh/config
    mv <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="nv">$HOME</span>/.ssh/config
    chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="k">fi</span>

<span class="c"># Finally run puppet. This *can* take a while.</span>
puppet apply --modulepath<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/modules --color <span class="nb">false</span><span class="se">\</span>
       --vardir /var/tmp/puppet/var --confdir /var/tmp/puppet/etc --no-report <span class="se">\</span>
       --logdest <span class="nv">$LOGDEST</span> /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
</code></pre>
</div>

</p>
                        </div>
                    </div>
                    <!-- <div class="span3 hidden-phone hidden-tablet">
                        <ul class="thumbnails pull-right hidden-800">
    <li class="span12">
        <div class="thumbnail avatar">
            <img src="/assets/img/avatar.jpg" alt>
            <h4>About Me</h4>
            <h5><a href="/about.html">Andrew Bunday</a></h5>
            <p>I'm a VFX technologist working London where I apply the majority of
                   my time solving problems related to Pipeline and Systems development.</p>
            <p>If you want to get in touch, please give me a shout via one of the
               links at the bottom of the page.</p>
        </a>
    </li>
</ul>

                    </div> -->
                </div>
            </div>
            <hr>

<div class="page-header">
  <h4>&copy; 2012. All rights reserved <small>All comments are my own and feel free to contact me via the links below.</small></h4>
</div>

<!-- <div class="row-fluid post-contact-thumbs">
    <div class="span4">
        <a href="https://twitter.com/itwat" target="_blank">
            <img src="/assets/img/twitter-bird-blue-on-white.png" alt="">
        </a>
    </div>
    <div class="span4">
        <a href="http://github.com/andrewbunday" target="_blank">
            <img src="/assets/img/octocat.png" alt="">
        </a>
    </div>
    <div class="span4">
        <a href="http://www.linkedin.com/in/andrewbunday" target="_blank">
            <img src="/assets/img/LinkedIn_Logo200x200.png" alt="">
        </a>
    </div>
</div> -->


        </div>
     </body>
</html>


