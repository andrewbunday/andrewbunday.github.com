<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Andrew Bunday Masterless mode puppet wrapper script</title>    

    <script type="text/javascript" src="/assets/js/jquery.js"></script>
    <script type="text/javascript" src="/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.stellar.min.js"></script>
    <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
    <script type="text/javascript" src="/photo/css_browser_selector.js"></script>

    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/>
    <link rel="stylesheet" type="text/css" href="/fancybox/source/jquery.fancybox.css?v=2.1.5" media="screen" />  

    <link rel="alternate" type="application/rss+xml" title="RSS Feed for andrewbunday.co.uk" href="/rss.xml" />

    <link rel="stylesheet" type="text/css" href="/photo/boostrap.css"/>
    <link rel="stylesheet" type="text/css" href="/photo/photo.css"/>

</head>

    <body>

        <script type="text/javascript">
            $(window).stellar();

            $(document).ready(function () {
                // scale the banner to fit the window
                $('.photo').css({ "height": $(window).innerHeight() - 50,
                                  "background-image": "url(http://farm4.staticflickr.com/3461/3947835362_305ed69eee_o.jpg)" 
                                });
                $('.photo-navbar').css({ "background-image": "url(http://farm4.staticflickr.com/3461/3947835362_305ed69eee_o.jpg)" });
                $('.footer').css({ "background-image": "url(http://farm4.staticflickr.com/3461/3947835362_305ed69eee_o.jpg)" });
            });

            $(document).ready(function () {
                // highlight the current pange
                $('a[href="' + this.location.pathname + '"]').addClass('activePage');
            });

            $(document).ready(function() {
                $(".fancybox").fancybox({
                                          helpers : {
                                            title: {
                                              type: 'outside'
                                            },
                                            overlay : {
                                              css : {
                                                'background' : 'rgba(46,46,46,0.8)',
                                              },
                                            },
                                          },
                                          padding: 0,
                                          closeBtn: false,
                                          arrows: false,
                                          nextClick: true,
                                          openEffect: 'elastic',
                                          openSpeed: 500
                                        });
            });
        </script>

        <div class="navbar transparent navbar-static-top photo-navbar">
            <div class="navbar-inner transparent main-navbar-inner">
                <div class="pull-right">
                    <ul class="nav transparent">
                        <!-- <li><a href="/new/">New</a></li> -->
                        <li><a href="/">Home</a></li>
                        <li><a href="/about/">About</a></li>
                        <li><a href="/posts/">Posts</a></li>
                        <li><a href="https://github.com/andrewbunday" target="_blank">Github</a></li>
                        <li><a href="http://www.linkedin.com/in/andrewbunday" target="_blank">LinkedIn</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container-fluid main-content">

            <div class="row-fluid" style="margin-top:-20px;">
                <div id="photo-banner" class="container photo" data-stellar-background-ratio="0.5" style="padding-top: 80px">

                    <div class="container">
                        <div class="row-fluid">
                            <div class="span6">Puppet</div>
                        </div>
                        <div class="row-fluid">
                            <div class="span6">Masterless Mode</div>
                        </div>
                        <div class="row-fluid">
                            <div class="span6">---</div>
                        </div>
                        <div class="row-fluid">
                            <div class="span6">Running puppet in masterless mode has its advantages, and disadvantages</div>
                        </div>
                    </div>  

                </div>

                <div class="container" style="padding-top:20px">
                    <h1>Masterless mode puppet wrapper script</h1>
                    <div class="row-fluid" style="margin-bottom:10px">
                        <div class="span8">
                            <p class="muted">Tue 04 Dec 2012</p>
                        </div>
                    </div>
                    <h3 class="no_toc" id="contents">Contents</h3>

<hr />

<ul class="nav nav-list well" id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#running-masterless">Running Masterless</a></li>
  <li><a href="#an-example-wrapper-script">An Example Wrapper Script</a></li>
</ul>

<h3 id="background">Background</h3>

<hr />

<p>Typically the easiest way to run puppet is to use the default master and agent
mechanism.</p>

<p>When you run puppet using a master the only way to switch between
different sets of manifests/modules is to use environments. If  you setup puppet
correctly these can allow you to pick and choose which environment you want to
use on a given run, and/or for a given node.</p>

<p>Unfortunately there are a few caveats when using environments.</p>

<ul>
  <li>To pick out a particular enviroment for a specific node each time you ideally
should be using an ENC. Once you setup your enviroment == node relationship it’ll
stick for each run.</li>
  <li>
    <p>If you are not using an ENC, since this is another server which you don’t want
to have to maintain then you are requried to specify the environment to use
via the commandline. For example:</p>

    <blockquote>
      <p><code>puppet agent --test --environment canary_maya_001</code></p>
    </blockquote>
  </li>
  <li>Each environment will need to have a different manifest/modulepath defined and
located in your puppet manifests.</li>
</ul>

<h3 id="running-masterless">Running Masterless</h3>

<hr />

<p>Another way of running puppet is to setup it up in in a masterless mode. Here we
instead checkout a copy of our manifest from a central repository and run puppet
directly against it.</p>

<p>Whilst you gain the advantage of not needing a master, and of being able to split
environments more easily with branches (this can be done with the master but requires
multiple checkouts of the puppet repository). You do loose out on a few features
of puppet, such as:</p>

<ul>
  <li>Reports, these really don’t work as well.</li>
  <li>StoreConfigs is probably the biggest feature loss although you should be able
to solve the problems you would have used it for in other ways (SSHFP for example
when handling new server certificates).</li>
  <li>To use a particular environment on a node it becomes easier to create branches
of your manifests/modules and then checkout the branch you want on the node
just before you execute puppet. This still means you have multiple ‘copies’ of
files, but managing them tends to be easier via standard git branch&amp;merge tools.</li>
</ul>

<h3 id="an-example-wrapper-script">An Example Wrapper Script</h3>

<hr />

<p>The steps involved in running masterless are slightly more cumbersome than
running with a master. In particular if you use a git server such as gitolite
then you need to ensure that you have credentials setup which allow you to read
from the repository.</p>

<p>For this we’re using a locally served ssh config file and private rsa id which
the config file informs ssh to use to identifty ourselves when we contact our
gitolite host.</p>

<p><em>served with a pinch of salt</em></p>

<div class="highlight"><pre><code class="bash"><span class="lineno"> 1</span> <span class="c">#!/usr/bin/env bash</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c"># check if sudo has been used or user is root</span>
<span class="lineno"> 4</span> <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${SUDO_USER}&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;${USER}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno"> 5</span> <span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Fail: Only root can execute puppet&quot;</span>
<span class="lineno"> 6</span>     <span class="nb">exit </span>1
<span class="lineno"> 7</span> <span class="k">fi</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># change to &#39;syslog&#39; to redirect puppet&#39;s internal logging directly to syslog</span>
<span class="lineno">10</span> <span class="nv">LOGDEST</span><span class="o">=</span><span class="s1">&#39;console&#39;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c"># this may be overkill. A time/datestamp or even standard path may be more</span>
<span class="lineno">13</span> <span class="c"># suitable.</span>
<span class="lineno">14</span> <span class="nv">UUID</span><span class="o">=</span><span class="sb">`</span>uuidgen<span class="sb">`</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c"># SSH credentials setup</span>
<span class="lineno">17</span> <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$HOME</span>/.ssh <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">18</span> <span class="k">    </span>mkdir --mode<span class="o">=</span>700 <span class="nv">$HOME</span>/.ssh
<span class="lineno">19</span> <span class="k">fi</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="c"># Stash $HOME/.ssh/config if it already exists. We&#39;ll put it back when we&#39;re</span>
<span class="lineno">22</span> <span class="c"># finished.</span>
<span class="lineno">23</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/config <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">24</span> <span class="k">    </span>mv <span class="nv">$HOME</span>/.ssh/config <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config
<span class="lineno">25</span> <span class="k">fi</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="nb">test</span> -x /usr/bin/wget <span class="o">||</span> <span class="nb">exit </span>1
<span class="lineno">28</span> wget -q -O <span class="nv">$HOME</span>/.ssh/config http://autoserver/d-i/bin/puppet_ssh.config
<span class="lineno">29</span> wget -q -O <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa <span class="se">\</span>
<span class="lineno">30</span>            http://autoserver/d-i/bin/puppet_readonly_id_rsa
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="c"># OpenSSH will bork out if the permissions are not exactly right.</span>
<span class="lineno">33</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/puppet_readonly_id_rsa
<span class="lineno">34</span> chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">35</span> 
<span class="lineno">36</span> <span class="c"># Clone a copy of the puppet manifests</span>
<span class="lineno">37</span> <span class="k">if</span> <span class="o">[</span> ! -d /var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">38</span> <span class="k">    </span>git clone gitlab:puppet.git /var/tmp/puppet/<span class="nv">$UUID</span>
<span class="lineno">39</span> <span class="k">fi</span>
<span class="lineno">40</span> 
<span class="lineno">41</span> <span class="c"># Get any updates to a previously checked out manifest repo</span>
<span class="lineno">42</span> <span class="k">if</span> <span class="o">[</span> -f /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">43</span> <span class="k">    </span>git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">44</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> fetch
<span class="lineno">45</span>     git --git-dir<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/.git <span class="se">\</span>
<span class="lineno">46</span>         --work-tree<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span> merge origin/master
<span class="lineno">47</span> <span class="k">fi</span>
<span class="lineno">48</span> 
<span class="lineno">49</span> <span class="c"># Return the users .ssh settings.</span>
<span class="lineno">50</span> <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="lineno">51</span> <span class="k">    </span>rm <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">52</span>     mv <span class="nv">$HOME</span>/.ssh/<span class="nv">$UUID</span>.config <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">53</span>     chmod 0600 <span class="nv">$HOME</span>/.ssh/config
<span class="lineno">54</span> <span class="k">fi</span>
<span class="lineno">55</span> 
<span class="lineno">56</span> <span class="c"># Finally run puppet. This *can* take a while.</span>
<span class="lineno">57</span> puppet apply --modulepath<span class="o">=</span>/var/tmp/puppet/<span class="nv">$UUID</span>/modules --color <span class="nb">false</span><span class="se">\</span>
<span class="lineno">58</span>        --vardir /var/tmp/puppet/var --confdir /var/tmp/puppet/etc --no-report <span class="se">\</span>
<span class="lineno">59</span>        --logdest <span class="nv">$LOGDEST</span> /var/tmp/puppet/<span class="nv">$UUID</span>/manifests/site.pp <span class="k">${</span><span class="nv">1</span><span class="k">}</span>
</code></pre></div>


                </div>

            </div>

            <div class="container" style="padding-top:20px"> 
                <div style="padding: 20px 0 20px 0">
                    <div id="disqus_container" class="row-fluid">
    <div class="span12">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dumbtechnotes'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
</div>
                </div>
            </div>

            <div class="container footer" data-stellar-background-ratio="0.5">
    <div class="row-fluid">
        <div class="span12 rights-reserved" style="text-align: center">
            &copy; 2014. All rights reserved. All comments are my own and not those of my employer.
        </div>
    </div>
</div>

        </div>
     </body>
</html>
