<!DOCTYPE html>
<html>
    <head>
        <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Proxmoxia <small>yet another Python API for Proxmox</small> / Andy Bunday</title>

    <link rel="shortcut icon" href="/assets/img/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/ubuntu.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/pygments.css"/>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for andrewbunday.co.uk" href="/rss.xml" />

    <script type="text/javascript" src="/assets/js/jquery.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-772003-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

    </head>
    <body>
        <div class="page">
            <div class="navbar navbar-static-top">
    <div class="navbar-inner main-navbar-inner">
        <div class="container-fluid main-navbar">
            <a class="btn btn-navbar pull-right" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
           </a>

            <div class="nav-collapse pull-right">
                <ul class="nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/posts.html">Posts</a></li>
                    <li><a href="https://github.com/andrewbunday" target="_blank">Github</a></li>
                    <li><a href="http://www.linkedin.com/in/andrewbunday" target="_blank">LinkedIn</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

            <div class="page-header">
  <h3>Andrew Bunday <small>tech notes</small></h3>
</div>

            <ul class="breadcrumb">
  <li><a href="/">home</a> <span class="divider">/</span></li>
  
    <li><a href="/posts.html">posts</a> <span class="divider">/</span></li>
  
  
    <li class="active">proxmoxia <small>yet another python api for proxmox</small></li>
  
</ul>


            <div class="container-fluid main-content">
                <div class="row-fluid">
                    <div class="span9 span12-tablet">
                        <div class="row-fluid">
                            <div class="span12">
                                <h1>Proxmoxia <small>yet another Python API for Proxmox</small></h1>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span8">
                                <p class="muted">Thu 18 Oct 2012</p>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <p><ul id="markdown-toc">
  <li><a href="#background">Background</a></li>
  <li><a href="#creating-proxmoxia">Creating Proxmoxia</a></li>
  <li><a href="#whats-next">Whats Next?</a></li>
  <li><a href="#finally-some-examples">Finally Some Examples</a></li>
</ul>

<hr />

<p>Today I’m happy to have finished up work on a small python wrapper for Proxmox’s rest based API. We’ve called it <a href="http://github.com/baseblack/proxmoxia">Proxmoxia</a>.</p>

<h2 id="background">Background</h2>

<p>For those who don’t know, <a href="http://pve.proxmox.com/wiki/Main_Page">Proxmox</a> is an open source server virtualization platform which allows you to create and manage any number of virtual machines based on either KVM or OpenVZ.</p>

<p>At Baseblack we utilise Proxmox to provide us with the majority of our central infrastructure. For example we run a pair of DNS servers, an almost countless number of license servers and farm manager all as openvz containers. Doing this provides us with a far higher level of service since if any one of our virtualization nodes go down we can quickly and pretty painlessly re-start the downed services on one of the other nodes whilst we work outs whats happening.</p>

<p>An area of active development for us is the automation of builds of new software packages for deployment onto our workstations, render nodes and virtual hosts.</p>

<blockquote>
  <p><em>This is where Proxmoxia comes in.</em></p>
</blockquote>

<p>Until recently anytime we’ve needed to spin up a new virtual server, we’ve needed to login to the web interface and manually create a new instance. Not only is this tedious and time consuming, but it can also lead to the occasional mistake.</p>

<p>We knew that our plans for automated builds, and testing of packages would involve us spinning up more and more sacrificial virtual machines which we could use as testing/build bots, each being discarded once they had completed their assigned tasks.</p>

<h2 id="creating-proxmoxia">Creating Proxmoxia</h2>

<p>After a short burst of <em>‘Spanish Flea’</em> our  preferred google search background music we found that the majority of the existing implementations of wrappers for the rest API had been in languages we either weren’t keen on or flat out refused to use.</p>

<blockquote>
  <p><em>Perl, Java, PHP need not apply</em></p>
</blockquote>

<p>Unfortunately I didn’t come across PyProxmox <em>(a major omission of mine)</em> until I’d already spent the better part of a day planning on how to make proxmoxia. And by then I well and truly had the bit between my teeth.</p>

<p>I wanted to create a library which followed a few simple rules:</p>

<ol>
  <li>It should ‘feel’ pythonic.</li>
  <li>I wanted the wrapper to extend itself. Or in a few more words; I didn’t want to have to personally write wrapper functions for each and every endpoint and method combination which are currently exposed in the rest api.</li>
</ol>

<p>Personally I don’t like PyProxmox’s implementation for both of these reasons which is why I feel justified in completing Proxmoxia.</p>

<h2 id="whats-next">Whats Next?</h2>

<p>We’re going to be using the library as part of our testing suite, creating new VMs off of the back of Jenkins builds. Hopefully it’s going to work out to be really useful.</p>

<h2 id="finally-some-examples">Finally Some Examples</h2>

<p>Okay, so here are some examples to show what I’m talking about. Head over to the <a href="http://github.com/baseblack/proxmoxia">github</a> site for the source for these.</p>

<p>First up, Proxmox uses a token based authentication mechanism which must be attached to the headers of each request.</p>

<p>Connect to any node in the cluster and get the auth_token:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">proxmox</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Connector</span><span class="p">(</span><span class="s">&#39;proxmox-1&#39;</span><span class="p">,</span> <span class="mi">8006</span><span class="p">)</span>
<span class="n">auth_token</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_auth_token</span><span class="p">(</span><span class="s">&#39;user@pam&#39;</span><span class="p">,</span> <span class="s">&#39;strawberries&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p>Next create Proxmox and Node access objects, these are the bread and butter of the library:</p>

<div class="highlight"><pre><code class="python"><span class="n">p</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Proxmox</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">proxmox</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s">&#39;proxmox-7&#39;</span><span class="p">)</span>  <span class="c"># this is on a different host.</span>
</code></pre>
</div>

<p>The library translates its requests into the url equivalent of what you call. So here we request the status on a vm with id number 108:</p>

<div class="highlight"><pre><code class="python"><span class="n">vmid</span> <span class="o">=</span> <span class="mi">108</span>
<span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="n">vmid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
</code></pre>
</div>

<p>Which is converted to the URL:</p>

<pre><code>http://proxmox-1:8006/api2/json/nodes/proxmox-7/openvz/108/status/current
</code></pre>

<p>Find a vm template filepath and use this as the ostemplate for a new vm you create. And then start it up once it has finished being created:</p>

<div class="highlight"><pre><code class="python"><span class="c"># find the path for the template you want to use.</span>
<span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">&#39;vztmpl&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*ubuntu-12.04-bb-20121010b_amd64.tar.gz$&#39;</span><span class="p">,</span> <span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">]):</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">storage</span><span class="p">(</span><span class="s">&#39;virtual-nfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s">&#39;volid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="c"># create the container, giving it some sensible settings</span>
<span class="n">taskid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="o">.</span><span class="n">post</span><span class="p">(</span> <span class="n">ostemplate</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">),</span>
                           <span class="n">vmid</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
                           <span class="n">hostname</span><span class="o">=</span><span class="s">&#39;test-4&#39;</span><span class="p">,</span>
                           <span class="n">ip_address</span><span class="o">=</span><span class="s">&#39;192.168.123.204&#39;</span><span class="p">,</span>
                           <span class="n">storage</span><span class="o">=</span><span class="s">&#39;local&#39;</span><span class="p">)</span>

<span class="c"># keep an eye on task and see when its completed</span>
<span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="p">()[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;running&#39;</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># print out the logs</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">tasks</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">line</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># start up the container</span>
    <span class="n">node</span><span class="o">.</span><span class="n">openvz</span><span class="p">(</span><span class="s">&#39;204&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unable to start container&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p>Find if a user exists and create them if they do not:</p>

<div class="highlight"><pre><code class="python"><span class="k">if</span> <span class="s">&#39;andrew.bunday@pve&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="p">()]:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="s">&#39;andrew.bunday@pve&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;test user&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;strawberries&quot;</span><span class="p">)</span>
</code></pre>
</div>

</p>
                        </div>
                    </div>
                    <div class="span3 hidden-phone hidden-tablet">
                        <ul class="thumbnails pull-right hidden-800">
    <li class="span12">
        <div class="thumbnail avatar">
            <img src="/assets/img/avatar.jpg" alt>
            <h4>About Me</h4>
            <h5><a href="/about.html">Andrew Bunday</a></h5>
            <p>I'm a VFX technologist working London where I apply the majority of
                   my time solving problems related to Pipeline and Systems development.</p>
            <p>If you want to get in touch, please give me a shout via one of the
               links at the bottom of the page.</p>
        </a>
    </li>
</ul>

                    </div>
                </div>
            </div>
            <div class="page-header">
  <h4>&copy; 2012. All rights reserved <small>All comments are my own and feel free to contact me via the links below.</small></h4>
</div>

<div class="row-fluid post-contact-thumbs">
    <div class="span4">
        <a href="https://twitter.com/itwat" target="_blank">
            <img src="/assets/img/twitter-bird-blue-on-white.png" alt="">
        </a>
    </div>
    <div class="span4">
        <a href="http://github.com/andrewbunday" target="_blank">
            <img src="/assets/img/octocat.png" alt="">
        </a>
    </div>
    <div class="span4">
        <a href="http://www.linkedin.com/in/andrewbunday" target="_blank">
            <img src="/assets/img/LinkedIn_Logo200x200.png" alt="">
        </a>
    </div>
</div>


        </div>
     </body>
</html>


